<!DOCTYPE html>
<html lang="en" ng-app="myApp">
<head>
    <meta charset="UTF-8"/>
    <title>Title</title>

    <!--jquery-->
    <script src="/webjars/jquery/1.11.1/jquery.min.js"></script>

    <!--jquery ui-->
    <script src="/webjars/jquery-ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="/webjars/jquery-ui/1.12.1/jquery-ui.min.css"/>

    <!--bootstrap-->
    <script src="/webjars/bootstrap/3.3.7-1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="/webjars/bootstrap/3.3.7-1/css/bootstrap.min.css"/>

    <!--editor.md https://github.com/pandao/editor.md-->
    <link rel="stylesheet" href="/lib/editormd-1.5.0/examples/css/style.css"/>
    <link rel="stylesheet" href="/lib/editormd-1.5.0/css/editormd.css"/>
    <link rel="shortcut icon" href="https://pandao.github.io/editor.md/favicon.ico" type="image/x-icon"/>

    <!--angularJS-->
    <script src="/webjars/angularjs/1.6.2/angular.min.js"></script>

    <!--my own-->
    <link rel="stylesheet" href="/css/index.css"/>
    <link rel="stylesheet" href="/css/index-toc-sideBar.css"/>
    <link rel="stylesheet" href="/css/index-toc.css"/>
    <script src="/js/angularJS/app.js"></script>
    <script src="/js/angularJS/appConfig.js"></script>
    <script src="/js/angularJS/appController.js"></script>
    <script src="/js/angularJS/appDirectives.js"></script>
    <script src="/js/angularJS/appService.js"></script>

</head>
<body>
<div id="myEditormdTocSidebar">
    <div class="editormd-preview-container" id="custom-toc-container"></div>
</div>
<div id="myEditormd">
<textarea>
# 1 ATG
## 1.1 BCC-test
### 1.1.1 删所有工程 删锁
table name: ATGPUB_ACRS.epub_project
```sql
begin
     for rl in ( select * from epub_project) loop
         -- Removing locks of the project if any
         delete from avm_asset_lock where workspace_id in
               (select id from avm_devline where name in
               (select workspace from epub_project where project_id = rl.project_id));

               -- delete history of the project
               delete from EPUB_PR_HISTORY where project_id in
        (select project_id from epub_project where project_id = rl.project_id);

               -- delete the project
               delete from epub_project where project_id = rl.project_id;

               -- delete history of the process
               delete from EPUB_PROC_HISTORY where process_id in
               (select process_id from epub_process where project = rl.project_id);

               -- delete task information of process
               delete from EPUB_PROC_TASKINFO where id in
               (select process_id from epub_process where project = rl.project_id);

               -- delete states of project (if any)
               delete  from EPUB_IND_WORKFLOW where process_id in
               (select process_id from epub_process where project = rl.project_id);

               -- finally delete the process
               delete from epub_process where project = rl.project_id;

        commit;
     end loop;
end ;
```

## 1.2 BCC 删单个工程 删锁
根据project名称，查找待删的project id:
```sql
select * from ATGPUB_ACRS.epub_project where displayName='XXXXXXX'
```
记下id,逐个替换并删除：
```sql
 -- Removing locks of the project if any
delete from ATGPUB_ACRS.avm_asset_lock where workspace_id in
      (select id from ATGPUB_ACRS.avm_devline where name in
      (select workspace from ATGPUB_ACRS.epub_project where project_id = 'prj223000'));

      -- delete history of the project
      delete from ATGPUB_ACRS.EPUB_PR_HISTORY where project_id in
(select project_id from ATGPUB_ACRS.epub_project where project_id = 'prj223000');

      -- delete the project
      delete from ATGPUB_ACRS.epub_project where project_id = 'prj223000';

      -- delete history of the process
      delete from ATGPUB_ACRS.EPUB_PROC_HISTORY where process_id in
      (select process_id from ATGPUB_ACRS.epub_process where project = 'prj223000');

      -- delete task information of process
      delete from ATGPUB_ACRS.EPUB_PROC_TASKINFO where id in
      (select process_id from ATGPUB_ACRS.epub_process where project = 'prj223000');

      -- delete states of project (if any)
      delete  from ATGPUB_ACRS.EPUB_IND_WORKFLOW where process_id in
      (select process_id from ATGPUB_ACRS.epub_process where project = 'prj223000');

      -- finally delete the process
      delete from ATGPUB_ACRS.epub_process where project = 'prj223000';
```

### 1.2.1 删除所有project
```sql
delete from ATGPUB_ACRS.EPUB_PROJECT;
delete from ATGPUB_ACRS.EPUB_PR_TG_AP_TS;
delete from ATGPUB_ACRS.EPUB_DEPLOYMENT;
delete from ATGPUB_ACRS.EPUB_PR_TG_DP_TS;
delete from ATGPUB_ACRS.EPUB_PROC_HISTORY;
delete from ATGPUB_ACRS.EPUB_PR_TG_DP_ID;
delete from ATGPUB_ACRS.EPUB_INT_PRJ_HIST;
delete from ATGPUB_ACRS.EPUB_PROC_TASKINFO;
delete from ATGPUB_ACRS.EPUB_WORKFLOW_STRS;
delete from ATGPUB_ACRS.EPUB_IND_WORKFLOW;
delete from ATGPUB_ACRS.EPUB_PROCESS;
delete from ATGPUB_ACRS.EPUB_PR_HISTORY;
delete from ATGPUB_ACRS.EPUB_PROC_HISTORY;
delete from ATGPUB_ACRS.avm_asset_lock;
Delete from ATGPUB_ACRS.epub_deployment
```


### 1.2.2 如果遇到BCC发布工程一直位于队列中Queued就是卡起不动, 需要init一下snapshot
[dyadmin](http://localhost:8180/dyn/admin/nucleus/atg/epub/DeploymentServer/)

在bcc agent projects列，找到已经发布的历史project，然后找到最新成功的一个，右侧记下snapshot号，在上面dyadmin输入，init一下就好了

## 1.3 Fulfillment
### 1.3.1 清空所有JMS
[详见](/home/terrencewei/develop/doc/ATG11.1/E52191_03/Platform.11-1/ATGPlatformProgGuide/html/s1206removingsqljmsdestinationsandsub01.html)

```sql
--Remove queue:
DELETE FROM ATGCORE_ACRS.dms_msg_properties
WHERE msg_id IN (SELECT msg_id
	FROM ATGCORE_ACRS.dms_queue_entry
	WHERE queue_id IN (SELECT queue_id
		FROM ATGCORE_ACRS.dms_queue
		WHERE queue_name LIKE 'Fulfillment%'));
DELETE FROM ATGCORE_ACRS.dms_msg
WHERE msg_id IN (SELECT msg_id
	FROM ATGCORE_ACRS.dms_queue_entry
	WHERE queue_id IN (SELECT queue_id
		FROM ATGCORE_ACRS.dms_queue
		WHERE queue_name LIKE 'Fulfillment%'));
DELETE FROM ATGCORE_ACRS.dms_queue_entry
WHERE queue_id IN (SELECT queue_id
	FROM ATGCORE_ACRS.dms_queue
	WHERE queue_name LIKE 'Fulfillment%');
DELETE FROM ATGCORE_ACRS.dms_queue
WHERE queue_name LIKE 'Fulfillment%';

--Remove topic:
DELETE FROM ATGCORE_ACRS.dms_msg_properties
WHERE msg_id IN (SELECT msg_id
	FROM ATGCORE_ACRS.dms_topic_entry
	WHERE subscriber_id IN (SELECT subscriber_id
		FROM ATGCORE_ACRS.dms_topic_sub
		WHERE topic_id IN (SELECT topic_id
			FROM ATGCORE_ACRS.dms_topic
			WHERE topic_name LIKE 'Fulfillment%')));
DELETE FROM ATGCORE_ACRS.dms_msg
WHERE msg_id IN (SELECT msg_id
	FROM ATGCORE_ACRS.dms_topic_entry
	WHERE subscriber_id IN (SELECT subscriber_id
		FROM ATGCORE_ACRS.dms_topic_sub
		WHERE topic_id IN (SELECT topic_id
			FROM ATGCORE_ACRS.dms_topic
			WHERE topic_name LIKE 'Fulfillment%')));
DELETE FROM ATGCORE_ACRS.dms_topic_entry
WHERE subscriber_id IN (SELECT subscriber_id
	FROM ATGCORE_ACRS.dms_topic_sub
	WHERE topic_id IN (SELECT topic_id
		FROM ATGCORE_ACRS.dms_topic
		WHERE topic_name LIKE 'Fulfillment%'));
DELETE FROM ATGCORE_ACRS.dms_topic_sub
WHERE topic_id IN (SELECT topic_id
	FROM ATGCORE_ACRS.dms_topic
	WHERE topic_name LIKE 'Fulfillment%');
DELETE FROM ATGCORE_ACRS.dms_topic
WHERE topic_name LIKE 'Fulfillment%';

```

## 1.4 RQL
### 1.4.1 只返回结果集中前几条结果
```xml
range+XXXX
```
比如，查询所有sku, 只返回前5条结果，用：
```xml
<query-items item-descriptor="sku">
all range+5
</query-items>
```

### 1.4.2 properties文件中长字符串有逗号的情况
[详见](http://betweengo.com/2006/10/11/atg-does-not-allow-property-values-with-commas-for-string-properties/)

ATG does not allow property values with commas for String[] properties
Posted on October 11, 2006
Typically when you have a property of Strings, either an array or a collection, you would set them like this:

foos=hello,good-bye,this is a test

In the above example if the foos property is of type String [], then ATG initializes foos to { “hello”, “good-bye”, “this is a test” }.

However if one of the String’s has a comma in it then this method won’t work because ATG will treat the comma as a delimiter. For example if foos is configured like this:

foos=hello,good-bye,this is a test\, a big test

then foos is initialized to { “hello”, “good-bye”, “this is a test”, “a big test” }

To get around this apparent limitation, which is documented in Bug #29380, ATG provides a class called atg.core.util.StringList. If you set the type of the foos property to StringList and configure it like this:

foos=hello,good-bye,this is a test,, a big test

then fools will be initialized to { “hello”, “good-bye”, “this is a test, a big test” }. Note that “,,” is the method for escaping commas when using StringList.

## 1.5 Repository
### 1.5.1 atg.repository.MutableRepository
对应某一个Repository
操作item的CRUD:
* C: createItem()->得到transient的item->item.setPropertyValue()->addItem()持久化
* U: getItemForUpdate()->得到transient的item->item.setPropertyValue()->updateItem()持久化
* D: removeItem()直接持久化的删除一个item

## 1.6 dsp标签
### 1.6.1 dsp form相关
* dsp input的class="hidden" 则该handle方法不会被触发
* dsp input的type="hidden" 如果不设置value=""的话则hanlde方法不会被触发而且页面初始化的时候就会报错说没有getter和setter在handle方法里

## 1.7 使一个session无效
参考BCNewSessionFilter.java
atg.servlet.ServletUtil#invalidateSessionsAndSessionNameContexts

```java
package com.beacon.filter;

import java.io.IOException;

import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import atg.servlet.ServletUtil;

/**
 * Change session when login
 * @author: peteryue
 * @version: 1.0, Apr 12, 2017
 */
public class BCNewSessionFilter implements Filter {

    private FilterConfig mFilterConfig;



    @Override
    public void init(FilterConfig pFilterConfig) throws ServletException {
        setFilterConfig(pFilterConfig);
    }



    @Override
    public void doFilter(ServletRequest pServletRequest, ServletResponse pServletResponse, FilterChain pFilterChain)
            throws IOException, ServletException {
        ServletContext ctx = getFilterConfig().getServletContext();
        HttpServletRequest httpRequest = (HttpServletRequest) pServletRequest;
        if ("post".equals(httpRequest.getMethod().toLowerCase()) && httpRequest.getRequestURI().contains("/register")
                && httpRequest.getParameter("/atg/userprofiling/ProfileFormHandler.login") != null) {
            HttpSession session = httpRequest.getSession(false);
            if (session != null) {
                ServletUtil.invalidateSessionsAndSessionNameContexts(httpRequest, session, true);
                ctx.log("BCNewSessionFilter invalite session for login");
            }
        }
        pFilterChain.doFilter(pServletRequest, pServletResponse);
    }



    @Override
    public void destroy() {
        setFilterConfig(null);
    }



    public FilterConfig getFilterConfig() {
        return mFilterConfig;
    }



    public void setFilterConfig(FilterConfig pFilterConfig) {
        mFilterConfig = pFilterConfig;
    }

}
```

# 2 Endeca
## 2.1 几个概念
### 2.1.1 refinement
PLP左边的选择，用于缩小用户的选择范围

### 2.1.2 NavigationState
当前的查询参数，是Endeca封装的一个准备向endeca发请求的准备类

### 2.1.3 Dimval
Endeca dimension的一个类，表示dimension树的一个节点

### 2.1.4 CartridgeConfig
通常就是从EX拿到的配置

### 2.1.5 RefinementSortType
RefinementSortType.STATIC
RefinementSortType.DYNAMIC
RefinementSortType.DEFAULT
Dynamic ranking orders the refinement dimension values by:
1. refinement count (descending), then by
2. static rank assigned (descending), then by
3. dimension value id (descending)

## 2.2 Develop Studio读取pipeline文件位于
```sh
/opt/endeca/apps/Site1_en/data/processing
```

## 2.3 BaseLine过程
理解EAC核心
```
/beacon-release-2/endeca/config/script/AppConfig.xml
```

其中为Dimension的属性：

如果product-output-config.xml

设置了某属性为si-dimension="true",则在Site1.prop_ref.xml里就不能有该属性

因为一个同名的属性只能是property或者dimension二选一，不能既是property又是dimension

## 2.4 BaseLine的源码位于
```
/beacon-release-2/endeca/config/script/DataIngest.xml
/opt/endeca/PlatformServices/11.1.0/lib/java
```

## 2.5 Workbench改为https后
[2:22:33 PM] Darcy Yang - 杨鑫: 改了HTTPs，有三块是必须要测试的：
1. Index
2. Eac Remote Scripts
3. Endeca Shell Scripts

1.指的是编索引整个流程

2.指的是/atg/commerce/endeca/index/ProductCatalogSimpleIndexingAdmin/，这个能调用起dgraph,forge,dgindx等就可以

3.指的是/opt/endeca/apps/Site1_en/control，下面的shell都是Endeca Scripts.

## 2.6 基础概念

缩写 | 解释
---|---
CAS | 将原始数据加工成Endeca Record让forge pipline来用
Forge | 将一般数据转换成Endeca Record
dgidx | 读取Endeca Record，将数据进行索引，编索引的进程
MDEX | 根据编好的索引数据去发起endeca query并返回查询结果
dgraph | MDEX引擎的一个进程
EAC | 用来管理所有Endeca组件的东西
CIM | Configuration and Installation Manager
CMS | Content Management System
IFCR | WorkbenchConfig.xml

### 2.6.1 Endeca由三部分组成
1. Endeca Information Transformation Layer (ITL)：
```
CAS：读取源数据并存储他们
Forge：读取CAS数据并加工成Endeca Record
```

2. Oracle Endeca MDEX Engine(MDEX)：
```
Dgidx：读取Endeca Record并编索引
Dgraph：MDEX的一个进程。接收request并发起query并返回结果
```

3. Endeca Application Tier(app)：
```
通过Endeca Assembler发起查询request给Dgraph并接收和处理查询结果
```

### 2.6.2 Endeca安装文件
1. CAS

2. Platform Services
```
Forge
Endeca Application Controller (EAC)
Logging and Reporting System
```

3. MDEX

4. Tools and Frameworks
```
Workbench with Experience Manager
Endeca Assembler
```

### 2.6.3 Data Foundry programs
Data Foundry component is composed of two core programs, Forge and Dgidx.
[详见](/home/terrencewei/develop/doc/ATG11.0/Endeca/PlatformService/PlatServ.110/pdf/ForgeGuide.pdf)

* Forge is the data processing program that transforms your source data into standardized, tagged Endeca records.
* Dgidx is the indexing program that reads the tagged Endeca records that were prepared by Forge and
creates the proprietary indices for the Endeca MDEX Engine.


### 2.6.4 What's CAS
endeca Content Acquisition System

The Endeca Content Acquisition System crawls data sources, converts documents and files to Endeca records, and stores them for use in an Forge pipeline.
[详见](https://solution.aaxisgroup.net/wiki/display/~darcyyang/Using+CAS+to+Load+Document+Data)

### 2.6.5 What's EAC
The Oracle Endeca Application Controller (EAC) is a control system you can use to control, manage, and monitor components in your Endeca implementation.

The EAC provides the infrastructure to support Endeca projects from design through deployment and runtime. It replaces the deprecated Control Interpreter, while leaving the Endeca tools (Developer Studio and Oracle Endeca Workbench) largely intact.

The EAC uses open standards, such as the Web Services Descriptive Language (WSDL), which makes the Application Controller platform- and language-independent. As a result, the Application Controller supports a wide variety of applications in production. It allows you to handle complex operating environments that support features such as partial updates, delta updates, phased MDEX

The EAC Central Server stores and propagates configuration for the following components across all EAC Agents:
* Forge — Data ingest software that transforms source data into tagged Endeca records.
* Dgidx — An MDEX Engine component that generates indices from Endeca records and sends them to all
Dgraphs.
* Dgraphs — The MDEX Engine software that processes queries against indexed records.
* Log Server — The MDEX Engine log server.
* Report Generator — The MDEX Engine report generator that generates reports from log files.

[详见](/home/terrencewei/develop/doc/ATG11.0/Endeca/Common11/Common.110/pdf/CommerceAdminGuide.pdf)
P14

[详见](/home/terrencewei/develop/doc/ATG11.0/Endeca/PlatformService/PlatServ.110/pdf/EACGuide.pdf)
P11

### 2.6.6 What's Forge
a lightweight ETL(Extract Transform Load) process

The first Endeca process used in building index.

"pipeline.epx" is used as input to Forge and contains the ETL instructions.

### 2.6.7 What's CMS
Content Management System

### 2.6.8 What's IFCR
The IFCR is a custom component that specifies user information for an Endeca Configuration Repository that is running inside Oracle Endeca Workbench. The deployment template scripts use the information to connect to an Endeca Configuration Repository and move configuration used by Authoring and Live Dgraphs, the media MDEX reference application, and the IFCR Backup Utility.

[详见](/home/terrencewei/develop/doc/ATG11.0/Endeca/ToolsAndFrameWork/ToolsAndFrameworks.110/pdf/DeploymentTemplateUsageGuide.pdf)
P38

To pass the customer's request to the Assembler, your Endeca application invokes the assemble() method as follows:
```java
ContentItem result = assembler.assemble(contentItem)
```

An application page typically requires several queries to the MDEX engine to retrieve all the content that it will display; these queries are made through a single call to the Assembler. The Assembler issues the individual queries and assembles the individual responses into a single result content item.

The result content item is a tree of content items

The Endeca Presentation API is based on three core classes:
* The HttpENEConnection class establishes connections with the MDEX Engine.
* The ENEQuery class builds the query to be sent to the MDEX Engine.
* The ENEQueryResults class contains the results of the MDEX Engine query.
```java
HttpENEConnection + ENEQuery = ENEQueryResults
```
伪代码：
```java
HttpENEConnection con = new HttpENEConnection(...);
ENEQuery q = new ENEQuery(...);
ENEQueryResults r = con.query(q);

ERec
setERec...()
Navigation
setNav...()
DimensionSearchResult
setDimSearch...()
AggrERec
setAggrERec...()
```

## 2.7 endeca/config/pipline下面几个xml文件的含义
[详见](/home/terrencewei/develop/doc/Endeca11.2/E66320_01/cas.11-2/Endecacasdev/html/ccasm_conversion_mapping.xmlsection_8A34ED8621AC43BC83E0ED5F4F2FABC9.html)

casDeveloperGuide

Index configuration mapping

The index configuration JSON file is constructed from multiple Forge-ouput XML files.

* <appName>.prop_refs.xml XML file contains information about all the attributes of the Endeca property type and their associated data type. The mapping is specified by the PROP_REF XML element with the NAME attribute specifying the property name and TYPE attribute specifying the data type of the property.
* <appName>.dimensions.xml XML file contains the list of Endeca dimensions.
* <appName>.record_filter.xml XML file contains information about all the attributes that can be filtered. These attributes are translated to the isRecordFilterable property in the <appName>_index-config.json file.
* <appName>.recsearch_config.xml XML file contains information about all the attributes that are searchable. These attributes are translated to the isRecordSearchEnabled property in the JSON file.
* <appName>.rollups.xml XML file contains information about all the roll up attributes. These attributes are translated to the isRollupKey property in the JSON file.
* <appName>.dimension_refs.xml XML file contains information about the MULTI multi-select-type dimensions. XML attribute of DIMENSION_REF XML node that gives the values for multi-select-type. These are translated to the multiSelectType property in the JSON file.
* <appName>.dimsearch_index.xml XML file contains information about hierarchical searchable dimensions. These dimensions are translated to the isHierarchicalDimensionSearchEnabled property in the JSON file
* <appName>.dval_ranks.xml XML file contains information about the dimension rankings. These rankings are translated to the displayOrder property in the JSON file.
* <appName>.recsearch_indexes.xml XML file contains information about the wild card search attributes and search index configuration. These are translated to the searchIndexConfig JSON Node in the JSON file
* <appName>.derived_props.xml XML file contains information about the all the derived properties for the Endeca Application.

## 2.8 Endeca连接配置文件
### 2.8.1 Workbench Connection
/atg/endeca/ApplicationConfiguration/
```properties
locales=en_US
workbenchPort=8006
workbenchHostName=localhost
baseApplicationName=ZANNA
/atg/endeca/assembler/cartridge/manager/DefaultWorkbenchContentSource
$class=atg.endeca.assembler.content.ExtendedWorkbenchContentSource
$scope=global
# Preview enabled
isAuthoring^=AssemblerSettings.previewEnabled
# Workbench app name
appName^=/atg/endeca/ApplicationConfiguration.defaultApplicationName
# Workbench default site
defaultSiteRootPath^=AssemblerSettings.defaultExperienceManagerPrefix
# Workbench host
host^=../../AssemblerApplicationConfiguration.workbenchHostName
# Workbench publishing port
serverPort=8007
# Client port (If client port is set to -1, system will assign an ephemeral port automatically)
clientPort=-1
#storeFactory=/atg/endeca/assembler/cartridge/manager/DefaultFileStoreFactory
```

### 2.8.2 Dgraph Connection
/atg/endeca/assembler/AssemblerApplicationConfiguration
```properties
logging.loggingDebug=true
localeService=/atg/userprofiling/LocaleService
defaultMdexHostName=localhost
defaultMdexPort=15001
applicationKeyToMdexHostAndPort=\
     ZANNA_en_US=localhost:15001,\
     ZANNA_zh_CN=localhost:15003,\
     TANNA_en_US=localhost:15005,\
     TANNA_zh_CN=localhost:15007
```

## 2.9 endeca导出app用的build命令参考
```xml
<target name="-exportNode" description="Export node to local.">
  <echo>Export node ${node} from ${app.name} to local data folder</echo>
  <exec executable="${app.path}/${app.name}/control/runcommand.sh" osfamily="unix" failonerror="yes">
   <arg value="IFCR" />
   <arg value="exportContent" />
   <arg value="${node}" />
   <arg value="./data/${app.name}/${node}" />
   <arg value="true" />
  </exec>
  <exec executable="${app.path}/${app.name}/control/runcommand.bat" osfamily="windows" failonerror="yes">
   <arg value="IFCR" />
   <arg value="exportContent" />
   <arg value="${node}" />
   <arg value="./data/${app.name}/${node}" />
   <arg value="true" />
  </exec>
  <echo>Finish import node ${node}.</echo>
 </target>

<target name="-exportNodes">
  <antcall target="-exportNode" description="Export pages node.">
   <param name="node" value="pages" />
   <param name="app.name" value="${app.name}" />
  </antcall>
  <antcall target="-exportNode" description="Export content node.">
   <param name="node" value="content" />
   <param name="app.name" value="${app.name}" />
  </antcall>
  <antcall target="-exportNode" description="Export redirects node.">
   <param name="node" value="redirects" />
   <param name="app.name" value="${app.name}" />
  </antcall>
  <antcall target="-exportNode" description="Export thesaurus node.">
   <param name="node" value="thesaurus" />
   <param name="app.name" value="${app.name}" />
  </antcall>
  <antcall target="-exportNode" description="Export userSegments node.">
   <param name="node" value="userSegments" />
   <param name="app.name" value="${app.name}" />
  </antcall>
 </target>

<target name="exportMF" description="Export MF Endeca Config from Endeca Workbench Repository">
  <echo>Start To Export ${mf.app.name} Config From Endeca Workbench</echo>
  <antcall target="-exportNodes">
   <param name="app.name" value="${mf.app.name}" />
  </antcall>
  <echo>Finish To Export ${mf.app.name} Config From Endeca Workbench</echo>
 </target>
```

## 2.10 Endeca代码
调用

`/opt/endeca/apps/SMPen/control`

其中的

`runcommand.sh`

加载了
`/SMPProject/endeca/deploy_tools/app-templates/base-app/config/script/AppConfig.xml`

之后调用了

`/home/terrencewei/develop/source_code_and_jars/endeca_app_jar/java`

```java
Controller.class
public static void main(String[] args)
private void parseArgs(String[] args)
```
关于此类的帮助：
```java
private void usage()
```
打印出来后是：
```java
USAGE:
java Controller [options] --app-config <app config> <object> <method> [args]

The controller will invoke a method on an object defined in the app
configuration document(s). Method return values are not captured and
only String arguments may be passed as method parameters. The controller
will typically be used to run scripts, components or utilities. More
complex invocations should usually be wrapped in a BeanShell script.

By default, the controller will compare provisioning in the app config
document(s) to the provisioning in the EAC. If any definition changes are
found, elements are re-provisioned.

  Available options:
    --help
        Displays this usage information. If app config
        document and object name specified, available
        methods will be displayed.
    --version
        Displays version information.
    --update-definition
        Updates application provisioning without invoking
        any action. Any specified object, method and args
        will be ignored.
    --skip-definition
        Skips the default provisioning check, invoking the
        requested action with the app definition currently
        provisioned in the EAC.
    --remove-app
        Removes the application from the EAC.
        WARNING: Any active components will be stopped.
    --print-status
        Displays the status of application components.
    --config-override <override props file>
        Name of an app configuration override properties
        file to read from the classpath. Multiple override
        files may be specified.

  <app config>
      Name of an app configuration document to read
      from the classpath. Multiple documents may be
      specified.
  <object>
      ID of object defined in app config document.
  <method>
      Method to invoke on the specified object. Default: run.
  [args]
      Arguments to pass to the specified method. Only String
      arguments are allowed. Methods requiring other
      argument types may be wrapped in BeanShell script.

Usage Examples:
  java Controller --app-config AppConfig.xml BaselineUpdate run
  java Controller --app-config AppConfig.xml LockManager releaseLock update_lock
  java Controller --help --app-config AppConfig.xml Forge
  java Controller --remove-app --app-config AppConfig.xml
```

## 2.11 Install in Linux
### 2.11.1 程序下载
download installer from
[Oracle](https://edelivery.oracle.com/osdc/faces/SearchSoftware)

need download:
* MDEX
* Platform Services
* Tools and Frameworks
* CAS (optional)

### 2.11.2 安装
#### 2.11.2.1 安装前准备工作
```sh
sudo mkdir ~/endeca
sudo chmod -R 777 ~/endeca
```

#### 2.11.2.2 MDEX
```sh
cd /home/docker/endeca_installer/MDEX/
sh mdex_6.4.1.2.763315_x86_64pc-linux.sh --target /home/docker/
source /home/docker/endeca/MDEX/6.4.1.2/mdex_setup_sh.ini
```

#### 2.11.2.3 Platform Services
install
```sh
cd /home/docker/endeca_installer/platformservices/
sh platformservices_614734339_x86_64pc-linux.sh --target /home/docker/
# EAC service port
8888
# EAC service shutdown port
8090
# Endeca Control System JCD
8088
# configure this host to run EAC
Y
# MDEX path
/home/docker/endeca/MDEX/6.4.1.2
# install jspref
Y
source /home/docker/endeca/PlatformServices/workspace/setup/installer_sh.ini
```
start service
```sh
sh /home/docker/endeca/PlatformServices/6.1.4/tools/server/bin/startup.sh
```
stop service
```sh
sh /home/docker/endeca/PlatformServices/6.1.4/tools/server/bin/shutdown.sh
```

#### 2.11.2.4 ToolsAndFrameworks
```sh
cp -r /home/docker/endeca_installer/ToolsAndFrameworks /home/docker/endeca/
sudo vi /etc/profile
export  ENDECA_TOOLS_CONF=/home/docker/endeca/ToolsAndFrameworks/3.1.2/server/workspace
export  ENDECA_TOOLS_ROOT=/home/docker/endeca/ToolsAndFrameworks/3.1.2
```
start service
```sh
sh /home/docker/endeca/ToolsAndFrameworks/3.1.2/server/bin/startup.
```
stop service
```sh
sh /home/docker/endeca/ToolsAndFrameworks/3.1.2/server/bin/shutdown.sh
```

#### 2.11.2.5 环境变量汇总
```sh
###############################################
export ANT_HOME="/usr/ant/apache-ant-1.9.7"
export DYNAMO_ROOT="/opt/ATG/"
export DYNAMO_HOME=$DYNAMO_ROOT/home
export JAVA_HOME="/opt/java/jdk1.6.0_115"
export JBOSS_HOME="/opt/jboss/jboss5"
export PATH=$JAVA_HOME/bin:$ANT_HOME/bin:$PATH

##########Endeca Menv variables############
# MDEX
source /home/docker/endeca/MDEX/6.4.1.2/mdex_setup_sh.ini

# PlatformServices
source /home/docker/endeca/PlatformServices/workspace/setup/installer_sh.ini

# ToolsandFramework
ENDECA_TOOLS_ROOT=/home/docker/endeca/ToolsAndFrameworks/3.1.2
ENDECA_TOOLS_CONF=$ENDECA_TOOLS_ROOT/server/workspace

##############################################
```sh

#### 2.11.2.6 共通shell
start Endeca
```sh
#!/bin/bash
echo "starting Platform Services..."
/bin/sh -c "/home/docker/endeca/PlatformServices/6.1.4/tools/server/bin/startup.sh"
sleep 1s
echo "starting ToolsAndFrameworks..."
/bin/sh -c "/home/docker/endeca/ToolsAndFrameworks/3.1.2/server/bin/startup.sh"
```
stop Endeca
```sh
#!/bin/bash
echo "starting Platform Services..."
/bin/sh -c "/home/docker/endeca/PlatformServices/6.1.4/tools/server/bin/shutdown.sh"
sleep 1s
echo "starting ToolsAndFrameworks..."
/bin/sh -c "/home/docker/endeca/ToolsAndFrameworks/3.1.2/server/bin/shutdown.sh"
```

### 2.11.3 查app加了哪些锁
```sh
eaccmd list-flags --app MyApp
```
意思就是
```sh
cd /opt/endeca/PlatformServices/11.1.0/bin
sh eaccmd.sh list-flags --app Site1_en
```

解锁：
```sh
cd /opt/endeca/apps/Site1_en/control
sh runcommand.sh LockManager releaseLock update_lock
```

### 2.11.4 重启Endeca
endeca_service.sh
```sh
start_endeca () {

  if $( ps -ef | grep -v grep | grep -wq -E  'PlatformServices|CAS|ToolsAndFrameworks' );then
    echo "endeca is already running,no need to start again."
    exit 1
  fi

  echo "starting CAS..."
  nohup sh /opt/endeca/CAS/11.1.0/bin/cas-service.sh &

  echo "starting Platform service..."
  sh  /opt/endeca/PlatformServices/11.1.0/tools/server/bin/startup.sh

  echo "starting Workbench..."
  sh /opt/endeca/ToolsAndFrameworks/11.1.0/server/bin/startup.sh

}
stop_endeca () {

  if ! $( ps -ef | grep -v grep | grep -wq -E  'PlatformServices|CAS|ToolsAndFrameworks' );then
    echo "endeca is already stopped,no need to stop again."
    exit 1
  fi

  echo "stop Platform service..."
  sh /opt/endeca/PlatformServices/11.1.0/tools/server/bin/shutdown.sh

  echo "stop Workbench..."
  sh /opt/endeca/ToolsAndFrameworks/11.1.0/server/bin/shutdown.sh

  echo "stop CAS..."
  sh /opt/endeca/CAS/11.1.0/bin/cas-service-shutdown.sh

}

restart_endeca () {
  stop_endeca
  sleep 6
  start_endeca
}
```

## 2.12 Endeca编索引失败的解决办法
### 2.12.1 ERROR: Could not open acquire_lock.status.
发生错误error在/opt/endeca/PlatformServices/workspace/logs/shell/Site1_en.emgr_update_update_mgr_settings.log
[详见](https://endecaworld.wordpress.com/2013/09/17/error-could-not-open-acquire_lock-status/)

Problem

When running initialize_services, you may encounter this error:-
```log
SEVERE: Utility 'emgr_update_update_mgr_settings' failed. Refer to utility logs in [ENDECA_CONF]/logs/shell on host ITLHost.
 Occurred while executing line 4 of valid BeanShell script:
 [[
1|
 2|
 3| IFCR.provisionSite();
 4| WorkbenchManager.updateWsConfig();
 5|
 6|
 ]]
[09.17.13 11:17:58] SEVERE: Caught an exception while invoking method 'run' on object 'InitialSetup'. Releasing locks.
```
If you open the $ENDECA_CONF/logs/shell/<app_name>.emgr_update_update_mgr_settings.log file, you will see the error log statement:-
```log
ERROR: Could not open acquire_lock.status.
Solution:-
```

This could result due to several issues:-

1) If you had exited the initialize_services script abruptly earlier (using Ctrl+C), you may face this issue. In such cases, this might solve the issue:

Release the lock using the following command:-

cd to <ENDECA_APPS_FOLDER>/<your_app_name>/control/

> .\runcommand.bat LockManager releaseLock update_lock

OR

> ./runcommand.sh LockManager releaseLock update_lock
2) In some installations your workbench hostname may have been setup incorreclty (eg: including the domain name, where your system does not have a domain name, etc)

Verify that the Workbench URL is correct in the file:

<ENDECA_APPS_FOLDER>/apps/<your_app_name>/config/script/WorkbenchConfig.xml
```xml
<property name="workbenchHost" value="localhost" />
<property name="workbenchPort" value="8006" />
<custom-component id="IFCR" host-id="ITLHost" class="com.endeca.soleng.eac.toolkit.component.IFCRComponent">
 <properties>
 <property name="repositoryUrl" value="http://localhost:8006/ifcr" />
 <property name="username" value="admin" />
 <property name="password" value="admin" />
 <property name="numExportBackups" value="3" />
 </properties>
</custom-component>
```
There are many other config files (open each one and see) in the same folder where there are references to the workbench URL. Make sure that you correct them too, in case you find it to be wrong in one place.

### 2.12.2 RecordStoreImpl.writeRecords()　java.lang.NullPointerException

自己遇到的问题：
首先是编索引/atg/commerce/search/ProductCatalogOutputConfig失败

store aux的log是显示documentSubmitter提交数据到cas的时候调用soap ui失败

看cas-service.log显示是空指针异常

通过设置Record Store配置，忽略无效数据：

```sh
sh recordstore-cmd.sh get-configuration -a Site1_en_record -f dataConfig.xml
```
修改配置
```xml
<ignoreInvalidRecords>true</ignoreInvalidRecords>
```
```sh
sh recordstore-cmd.sh set-configuration -a Site1_en_record -f dataConfig.xml
```
再编索引，成功，但是cas里一条数据都没有

再看cas-service.log显示是record没有generate出来id，即dimval.spec没有生成

原因是在ProductCatalogOutputConfig.properties中设置了idOutputPropertyName=id

但是在xml定义文件definitionFile＝...sku-output-config.xml中，并没有某一个属性的output-name="id"

因此导致record id无法生成

## 2.13 Endeca Workbench SSL Guide
### 2.13.1 step 1
```sh
cd /opt/endeca/ToolsAndFrameworks/11.1.0/deployment_template/ssl_certs_utility/bin
sh generateSSLCertificates.sh
/opt/endeca/ToolsAndFrameworks/11.1.0/server/workspace/credential_store/
/opt/endeca/PlatformServices/11.1.0/bin
localhost
beacon123
beacon123
ks-endeca
N
ts-endeca
N
```
if want to generate again, delete all the certs first:
```sh
rm -rf /opt/endeca/ToolsAndFrameworks/11.1.0/deployment_template/ssl_certs_utility/bin/ssl/*
```

### 2.13.2 step 2
```sh
cd /opt/endeca/ToolsAndFrameworks/11.1.0/server/workspace/conf/
cp /opt/endeca/ToolsAndFrameworks/11.1.0/deployment_template/ssl_certs_utility/bin/ssl/localhost.ks .
cp /opt/endeca/ToolsAndFrameworks/11.1.0/deployment_template/ssl_certs_utility/bin/ssl/TS-localhost.ks .
cp server.xml server.xml_bak
vi server.xml
```
1. comments:
```xml
    <!-- BC835
    <Connector port="8006" protocol="HTTP/1.1"
                   connectionTimeout="20000"
                   maxPostSize="0"
                   redirectPort="8446"
                   URIEncoding="UTF-8"/>
    -->
```
2. remove comments and update:
```xml
<Connector port="8446" SSLEnabled="true"
           protocol="org.apache.coyote.http11.Http11Protocol"
           maxPostSize="0"
           maxThreads="150" scheme="https" secure="true"
           clientAuth="false" sslProtocol="TLS"
           keystoreFile="conf/localhost.ks" keystorePass="beacon123"
           truststoreFile="conf/TS-localhost.ks" truststorePass="beacon123"
           URIEncoding="UTF-8"
/>
```
```sh
mkdir /tmp/workbench-SSL-bak
cp server.xml /tmp/workbench-SSL-bak/
```

### 2.13.3 step 3
```sh
cd /opt/endeca/apps/Site1_en/control
cp runcommand.sh runcommand.sh_bak
vi runcommand.sh
```
after the existing JAVA_ARGS,
```sh
JAVA_ARGS="${JAVA_ARGS} -Djava.util.logging.config.file=${WORKING_DIR}/../config/script/logging.properties"
add the new lines below:
# Add keyStore&trustStore to java args--start--BC-835
TRUSTSTORE=/opt/endeca/ToolsAndFrameworks/11.1.0/server/workspace/conf/TS-localhost.ks
KEYSTORE=/opt/endeca/ToolsAndFrameworks/11.1.0/server/workspace/conf/localhost.ks
JAVA_ARGS="${JAVA_ARGS} -Djavax.net.ssl.trustStore=${TRUSTSTORE}"
JAVA_ARGS="${JAVA_ARGS} -Djavax.net.ssl.trustStoreType=JKS"
JAVA_ARGS="${JAVA_ARGS} -Djavax.net.ssl.trustStorePassword=beacon123"
JAVA_ARGS="${JAVA_ARGS} -Djavax.net.ssl.keyStore=${KEYSTORE}"
JAVA_ARGS="${JAVA_ARGS} -Djavax.net.ssl.keyStoreType=JKS"
JAVA_ARGS="${JAVA_ARGS} -Djavax.net.ssl.keyStorePassword=beacon123"
OCS_ARGS="-Dcom.endeca.ssl.jpsConfigPath=/opt/endeca/ToolsAndFrameworks/11.1.0/server/workspace/credential_store/jps-config.xml -Dcom.endeca.ssl.storeMapName=oracleCommerceSSLPassPhrase -Dcom.endeca.ssl.trustStoreKeyName=ts-endeca -Dcom.endeca.ssl.keyStoreKeyName=ks-endeca"
JAVA_ARGS="${JAVA_ARGS} ${OCS_ARGS}"
# Add keyStore&trustStore to java args--end--BC-835
```
then
```
cp runcommand.sh /tmp/workbench-SSL-bak/

```
### 2.13.4 step 4
```sh
cd /opt/endeca/apps/Site1_en/config/script
cp LiveAppServerCluster.xml LiveAppServerCluster.xml_bak
vi LiveAppServerCluster.xml
```
```xml
<app-server id="LiveDiscover" hostName="XXXX" port="8446">
```

enabled ssl:
```xml
<web-app id="DiscoverWebApp1" contextPath="/discover" sslEnabled="true"/>
<web-app id="DiscoverAssemblerApp1" contextPath="/assembler" sslEnabled="true"/>
```

if workbench uses fileStoreFactory, then:
add app-servers that presents the storefront server
For PROD, there are two storefront server, so:
```xml
<app-server-cluster id="LiveAppServerCluster">
  ...
  <app-server ref="Store1" />
  <app-server ref="Store2" />
  ...
</app-server-cluster>

<app-server id="Store1" hostName="11.22.33.44" port="8080">
  <web-app ref="StoreApp" />
</app-server>
<app-server id="Store2" hostName="11.22.33.45" port="8080">
  <web-app ref="StoreApp" />
</app-server>

<web-app id="StoreApp" contextPath="/dyn/admin/assemblerAdmin" />
```xml

if the storefront use https, then:
generate certs:
```sh
cd /opt/endeca/ToolsAndFrameworks/11.1.0/credential_store/bin/
sh manage_credentials.sh add --key webAppAdminCredentialsKey --user admin
admin123
```sh

update app-server's port:
```sh
<app-server id="Store1" hostName="11.22.33.44" port="8443">
<app-server id="Store2" hostName="11.22.33.45" port="8443">
```

add credentials to store app:
```xml
<basic-credentials id="webAppAdminCredentials" credentialStore="csfManager" credentialsKey="webAppAdminCredentialsKey" />
<web-app id="StoreApp" contextPath="/dyn/admin/assemblerAdmin" adminCredentials="webAppAdminCredentials" sslEnabled="true"/>
```
```sh
cp LiveAppServerCluster.xml /tmp/workbench-SSL-bak/
```

### 2.13.5 step 5
```sh
cd /opt/endeca/apps/Site1_en/config/script
cp WorkbenchConfig.xml WorkbenchConfig.xml_bak
vi WorkbenchConfig.xml
```
add below above
```xml
<custom-component
        id="WorkbenchManager"...
<ssl-config id="globalSslConfig">
  <property name="certFile" value="/opt/endeca/ToolsAndFrameworks/11.1.0/deployment_template/ssl_certs_utility/bin/ssl/localhost.pem"/>
  <property name="caFile" value="/opt/endeca/ToolsAndFrameworks/11.1.0/deployment_template/ssl_certs_utility/bin/ssl/ca-cert.pem"/>
  <property name="cipher" value="AES128-SHA"/>
</ssl-config>

<custom-component id="WorkbenchManager" host-id="ITLHost" class="com.endeca.soleng.eac.toolkit.component.WorkbenchManagerComponent">
  <ssl-config bean="sslConfig" ref="globalSslConfig"/>
...
<property name="workbenchPort" value="8446" />
...
</custom-component>

<custom-component id="IFCR" host-id="ITLHost" class="com.endeca.soleng.eac.toolkit.component.IFCRComponent">
...
<property name="repositoryUrl" value="https://@workbench.host@:@workbench.port@/ifcr" />
...
</custom-component>
```
```sh
cp WorkbenchConfig.xml /tmp/workbench-SSL-bak/
```

### 2.13.6 step 6
```sh
cd /home/atg/projects/
cp atg.properties atg.properties_bak
vi atg.properties
```
```
workbench_host=localhost
workbench_port=8446
```
```sh
cp /tmp/workbench-SSL-bak/* .
rm server.xml
```

because of  'ant all' will override the above updated files,
so here we must copy the updated files here and after 'ant all' finished, copy there files again into code and override it.

All the files that we updated:
* runcommand.sh
* LiveAppServerCluster.xml
* WorkbenchConfig.xml
* atg.properties

because of 'server.xml' will not be effected with 'ant all', so here there is no need to copy it.

### 2.13.7 step 7

env.xls

storefront:

/atg/endeca/ApplicationConfiguration
```
workbenchPort=8446
workbenchHostName=<workbench URL>
```

/atg/endeca/assembler/cartridge/manager/AssemblerSettings
```
previewModuleUrl=https://<workbench URL>:8446/ifcr
```

/etc/hosts:

Make sure the workbench server's /etc/hosts file have the domain <workbench URL>
the ip is the workbench server's ip itself. Also pay attention DO NOT USE localhost or 127.0.0.1 as ip.

Restart Endeca server
```
cd /opt/endeca/ToolsAndFrameworks/11.1.0/server/bin
shutdown.sh
startup.sh
```

old backup:
```
/opt/endeca/ToolsAndFrameworks/11.1.0/server/webapps
ifcr-11.1.0.war
/WEB-INF/web.xml
    <security-constraint>
        <web-resource-collection>
            <web-resource-name>Entire Site</web-resource-name>
            <url-pattern>/*</url-pattern>
            <http-method>GET</http-method>
            <http-method>POST</http-method>
        </web-resource-collection>
        <user-data-constraint>
            <transport-guarantee>CONFIDENTIAL</transport-guarantee>
        </user-data-constraint>
    </security-constraint>



refers:
---------
keytool -import -v -trustcacerts -file ca-cert.pem -keystore becn1.jks -storepass beacon123
/opt/endeca/ToolsAndFrameworks/11.1.0/deployment_template/ssl_certs_utility/bin/ssl
------
/opt/endeca/ToolsAndFrameworks/11.1.0/server/workspace/conf/Standalone/localhost
ROOT.xml
docBase="${catalina.base}/../webapps/workbench-legacy-tools-11.1.0-ssl.war"
----------------------------------------------------------------------------------------------------------
keytool -import -v -trustcacerts -file ca-key.pem -keystore becn2.jks -storepass beacon123
keytool -genkey -alias endeca -keyalg RSA -keystore becn3.jks -keypass beacon123 -storepass beacon123 -validity 7200
keytool -genkey -alias foo -keyalg RSA -keystore foo.keystore -validity 10950

/opt/endeca/ToolsAndFrameworks/11.1.0/server/j2sdk
/opt/java/jdk

export JAVA_HOME=/opt/endeca/ToolsAndFrameworks/11.1.0/server/j2sdk
export JAVA_HOME=/opt/java/jdk
----------------------------------------------------------------------------------------------------------
Update server.xml webstudio.properties
/opt/endeca/ToolsAndFrameworks/11.1.0/server/workspace/conf

See Tomcat's log
/opt/endeca/ToolsAndFrameworks/11.1.0/server/workspace/logs
catalina.out

Restart Endeca server
cd /opt/endeca/ToolsAndFrameworks/11.1.0/server/bin
shutdown.sh
startup.sh

Generate certs
/opt/endeca/ToolsAndFrameworks/11.1.0/deployment_template/ssl_certs_utility/bin/ssl
keytool xxxxxx

Test SSL
/opt/endeca/apps/Site1_en/control
export_site.sh

Endeca used JDK:
/opt/endeca/ToolsAndFrameworks/11.1.0/server/j2sdk

```
## 2.14 更改workbench获取content模式
Oracle Commerce Guided Search provides two methods for retrieving promoted Experience Manager content from the Workbench: a direct method, in which data is transferred via remote calls to the Workbench server, and a file-based method, in which EAC application data is published to the file system and retrieved from there.
[详见](http://docs.oracle.com/cd/E52191_03/Platform.11-1/ATGEndecaIntegrationGuide/html/s0901retrievingpromotedcontent01.html)
### 2.14.1 Preview模式用direct method
```properties
/atg/endeca/assembler/cartridge/manager/AssemblerSettings
previewEnabled=true

/atg/commerce/endeca/index/EndecaScriptService
baselineScriptName=AuthoringBaselineUpdate
```
更改
```
cd /opt/endeca/apps/Site1_en/config/script
vi AuthoringDgraphCluster.xml
// 改成对应Authoring MDEX的host和port即可
```
### 2.14.2 Live模式用file-based method
```properties
/atg/endeca/assembler/cartridge/manager/AssemblerSettings
previewEnabled=false

/atg/commerce/endeca/index/EndecaScriptService
baselineScriptName=LiveBaselineUpdate

/atg/endeca/assembler/cartridge/manager/DefaultWorkbenchContentSource
storeFactory=/atg/endeca/assembler/cartridge/manager/DefaultFileStoreFactory

/atg/endeca/assembler/cartridge/manager/WorkbenchContentSource_en_US
storeFactory=/atg/endeca/assembler/cartridge/manager/DefaultFileStoreFactory

/atg/endeca/assembler/cartridge/manager/WorkbenchContentSource_Site1_en_US
storeFactory=/atg/endeca/assembler/cartridge/manager/DefaultFileStoreFactory

/atg/endeca/assembler/cartridge/manager/WorkbenchContentSource_Site1_zh_CN
storeFactory=/atg/endeca/assembler/cartridge/manager/DefaultFileStoreFactory

/atg/endeca/assembler/cartridge/manager/WorkbenchContentSource_Site2_en_US
storeFactory=/atg/endeca/assembler/cartridge/manager/DefaultFileStoreFactory

/atg/endeca/assembler/cartridge/manager/WorkbenchContentSource_zh_CN
storeFactory=/atg/endeca/assembler/cartridge/manager/DefaultFileStoreFactory

/atg/endeca/assembler/cartridge/manager/DefaultFileStoreFactory
configurationPath=/opt/endeca/ToolsAndFrameworks/11.1.0/server/workspace/state/repository/Site1_en
```
更改
```
cd /opt/endeca/apps/Site1_en/config/script
vi LiveDgraphCluster.xml
// 改成对应Live MDEX的host和port即可
```

# 3 Java
## 3.1 Java代码
### 3.1.1 性能优化-代码层面
#### 3.1.1.1 位运算符
[详见](http://blog.csdn.net/vebasan/article/details/6193916)

[方法native关键字 JNI的实现实例](http://blog.csdn.net/xw13106209/article/details/6989415)

#### 3.1.1.2 list遍历
对于ArrayList: 本质是一个动态数组

判空不要用.size(), size()会触发一个循环遍历，降低效率?

取值时不要用foreach循环，用.get(index)方式，速度最快[详见](http://renjieguixiong5.iteye.com/blog/1022007)

总结：只遍历用Arrarlist，只要有修改就用linkedList，如果修改中还有遍历则是LinkedList+iterator接口遍历。
LinkedList: 本质是一个双向链表，千万别用.get(index)方法获取元素！！速度极慢！

### 3.1.2 性能优化-业务逻辑层面
查询数据库只查一次，将后续需要的数据一次全查出来放到bean里，后续只对bean在内存中进行操作

### 3.1.3 自定义数据类型在map
调用HashMap.put时为达到元素不重复的目的，需要在对象内重写equals和hashCode方法
调用ArrayList.contains时为达到目的，需要在对象内重写equals方法
例：
```java
public class BCVariationType extends VariationType {
    @Override
    public boolean equals(Object pObj) {
        if (this == pObj) {
            return true;
        }
        if (pObj == null || getClass() != pObj.getClass()) {
            return false;
        }
        String superId = super.getTypeId();
        String pId = ((BCVariationType) pObj).getTypeId();
        if (superId != null ? !superId.equals(pId) : pId != null) {
            return false;
        }

        return true;
    }
    @Override
    public int hashCode() {
        String superId = super.getTypeId();
        return superId != null ? superId.hashCode() : 0;
    }
}
```

### 3.1.4 遍历Map
用Entry来取得key和value速度最快

### 3.1.5 Collection.sort
采用的是合并排序算法

### 3.1.6 TransactionManager
[详见](http://fengzl.iteye.com/blog/164282)
#### 3.1.6.1 挂起和继续
```java
// obtain UserTransaction object and start transaction
InitialContext ctx = new InitialContext();
UserTransaction userTransaction = (UserTransaction)
    ctx.lookup("java:comp/UserTransaction");

// start first transaction
userTransaction.begin();

// obtain TransactionManager
// using one of the methods described above
TransactionManager tm = getTransactionManager();

// suspend transaction
// suspend() returns reference to suspended
// Transaction object which later should be passed
// to resume()
Transaction transaction = tm.suspend();

// here you can do something outside of transaction
// or start new transaction,
// do something and then commit or rollback
userTransaction.begin();

// commit subtransaction
userTransaction.commit();

// resume suspended transaction
tm.resume(transaction);

// commit first transaction
userTransaction.commit();
...
```
### 3.1.7 EJB事务控制（CMT和BMT两种方式以及JTA事务）
JTA: java transaction api
bean managed transaction
container managed transaction

[详见](http://www.cnblogs.com/jiwuyf/p/3794777.html)

[详见](http://www.07net01.com/2015/08/889329.html)

### 3.1.8 事务隔离级别
[详见](http://blog.csdn.net/sundenskyqq/article/details/7538776)

### 3.1.9 TransactionManager的rollback()和setRollbackOnly()
[详见](http://www.tuicool.com/articles/rYR3mm)

Transaction status含义
在java 6里：

name | value
---|---
STATUS_ACTIVE | 0
STATUS_MARKED_ROLLBACK | 1
STATUS_PREPARED | 2
STATUS_COMMITTED | 3
STATUS_ROLLEDBACK | 4
STATUS_UNKNOWN | 5
STATUS_NO_TRANSACTION | 6
STATUS_PREPARING | 7
STATUS_COMMITTING | 8
STATUS_ROLLING_BACK | 9


[详见](http://docs.oracle.com/javaee/6/api/index.html?javax/transaction/UserTransaction.html)

[详见](http://stackoverflow.com/questions/11440060/usertransaction-getstatus-always-returns-6)

### 3.1.10 分割字符串的类
```java
java.util.StringTokenizer
```

### 3.1.11 Properties类
[详见](http://www.cnblogs.com/bakari/p/3562244.html)

### 3.1.12 Observable类 观察者模式
```java
java.util.Observable
```

### 3.1.13 forName方法
```java
Class.forName(shippingClassName).newInstance();
```

### 3.1.14 new Date()
这时候取出来的时间已经是加了server端timezone的了
```java
Calendar cal = Calendar.getInstance();
TimeZone timeZone = cal.getTimeZone();
timeZone.getDisplayName();
```

### 3.1.15 货币，钱的保存类型和计算
要用`BigDecimal`，不要用Double, Float等

## 3.2 JBoss 实时调试代码的插件
[详见](http://ssw.jku.at/dcevm/binaries/)

JVM　Dynamic　Code　Update　Tool

## 3.3 SpringBoot
### 3.3.1 修改默认启动端口
http://blog.csdn.net/yingxiake/article/details/51260302
spring boot允许你自定义一个application.properties文件，然后放在以下的地方，来重写spring boot的环境变量或者定义你自己环境变量
当前目录的 “/config”的子目录下
当前目录下
classpath根目录的“/config”包下
classpath的根目录下

我自己的最佳实践:
新建文件:
src/main/resources/config/application.properties
server.port=8081
即可

### 3.3.2 使用Spring注解
http://blog.csdn.net/linzhiqiang0316/article/details/52639888
@SpringBootApplication的所在类作为顶层package,会扫描其下开始的所有类中的注解

## 3.4 Spring相关知识
### 3.4.1 Spring-data-jpa
#### 3.4.1.1 JPA
sun官方规定的一些orm持久层规范,想法是想统一所有orm接口的实现
#### 3.4.1.2 Spring在orm层的野心
[Spring-data-jpa是spring对JPA的一种实现](http://www.cnblogs.com/dreamroute/p/5173896.html)

继承接口,在接口里按规则定义方法名,剩下无需写实现即可直接用,由该框架自动来实现
方法名的[命名规则](http://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods.query-creation )如下:

*Table 4. Supported keywords inside method names*
Keyword | Sample | JPQL snippet
---|---|---
And | findByLastnameAndFirstname | … where x.lastname = ?1 and x.firstname = ?2
Or | findByLastnameOrFirstname | … where x.lastname = ?1 or x.firstname = ?2
Is,Equals | findByFirstname,<code>findByFirstnameIs,<code>findByFirstnameEquals | … where x.firstname = ?1
Between | findByStartDateBetween | … where x.startDate between ?1 and ?2
LessThan | findByAgeLessThan | … where x.age &lt; ?1
LessThanEqual | findByAgeLessThanEqual | … where x.age &lt;= ?1
GreaterThan | findByAgeGreaterThan | … where x.age &gt; ?1
GreaterThanEqual | findByAgeGreaterThanEqual | … where x.age &gt;= ?1
After | findByStartDateAfter | … where x.startDate &gt; ?1
Before | findByStartDateBefore | … where x.startDate &lt; ?1
IsNull | findByAgeIsNull | … where x.age is null
IsNotNull,NotNull | findByAge(Is)NotNull | … where x.age not null
Like | findByFirstnameLike | … where x.firstname like ?1
NotLike | findByFirstnameNotLike | … where x.firstname not like ?1
StartingWith | findByFirstnameStartingWith | … where x.firstname like ?1 (parameter bound with appended <code>%)</p></td>
            EndingWith | findByFirstnameEndingWith | … where x.firstname like ?1 (parameter bound with prepended <code>%)</p></td>
                Containing | findByFirstnameContaining | … where x.firstname like ?1 (parameter bound wrapped in <code>%)</p></td>
                    OrderBy | findByAgeOrderByLastnameDesc | … where x.age = ?1 order by x.lastname desc
Not | findByLastnameNot | … where x.lastname &lt;&gt; ?1
In | findByAgeIn(Collection&lt;Age&gt; ages) | … where x.age in ?1
NotIn | findByAgeNotIn(Collection&lt;Age&gt; age) | … where x.age not in ?1
True | findByActiveTrue() | … where x.active = true
False | findByActiveFalse() | … where x.active = false
IgnoreCase | findByFirstnameIgnoreCase | … where UPPER(x.firstame) = UPPER(?1)

### 3.4.2 动态代理
[详见](http://blog.csdn.net/dreamrealised/article/details/12885739     )
#### 3.4.2.1 JDK的动态代理
实现`java.lang.reflect.InvocationHandler`接口,实现`invoke`方法即可
但是要求所有被AOP代理的类都要有一个一致的父类接口,在handler里只能对该接口进行操作,所以条件比较苛刻

#### 3.4.2.2 cglib动态代理
cglib开源框架就没有jdk官方的动态代理这么条件苛刻,因为它是直接修改的class字节码
CGLIB包的底层是通过使用一个小而快的字节码处理框架ASM

#### 3.4.2.3 字节码处理框架ASM
直接使用ASM，它要求你必须对JVM内部结构包括class文件的格式和指令集都很熟悉
[详见](http://baike.baidu.com/item/ASM/5646156#viewPageContent)

jdk和cglib两种动态代理Spring都支持,只需修改xml配置文件即可

### 3.4.3 数据库
#### 3.4.3.1 MySQL
```java
spring.datasource.url=jdbc:mysql://localhost/test
spring.datasource.username=dbuser
spring.datasource.password=dbpass
spring.datasource.driver-class-name=com.mysql.jdbc.Driver
```

#### 3.4.3.2 内存数据库hsqldb
spring配置文件中添加:
```java
#添加以下配置到配置文件，可存入本地：
spring.jpa.show-sql = true
spring.jpa.hibernate.ddl-auto = update
#spring.datasource.url = jdbc\:hsqldb\:file\:D\:\\test\\testdb2
spring.datasource.url = jdbc:hsqldb:file:~/.hsqldb/mytestdb
spring.datasource.username = sa
spring.datasource.password = org.omg.PortableServer._ServantActivatorStub
spring.datasource.driverClassName =org.hsqldb.jdbcDriver
```

### 3.4.4 自动加载的静态页面
Spring Boot 会自动在 `/static` 或者 `/public` 或者 `/resources` 或者 `/META-INF/resources` 加载静态页面


# 4 Linux
## 4.1 shell
### 4.1.1 远程桌面
```sh
rdesktop -f <ip地址> -u <user name> -p <password> -d <domain name>
```
取消全屏快捷键是`ctrl+alt+enter`

### 4.1.2 循环执行某个命令，每2秒一次，直到按Ctrl+C退出
```sh
watch <command>
```

### 4.1.3 查看磁盘大小
```sh
df -h
```

### 4.1.4 查看目录大小
```sh
du -h  --max-depth=1 |sort -nr|more
```

### 4.1.5 级联更改子目录权限
```sh
sudo chmod -R 777 /opt/cache
```

### 4.1.6 查看端口占用
```sh
netstat -ano|grep <端口号>
```

### 4.1.7 查看进程
```sh
ps -ef|grep <进程ID>
```
### 4.1.8 杀进程
```sh
kill -9 <进程号>
```

### 4.1.9 改host
```sh
sudo vi /etc/hosts
```

### 4.1.10 查找文件在哪里
```sh
find <findPath> |grep <fileName> 2>/dev/null
```
例：
```sh
find /opt/endeca/ |grep server.xml 2>/dev/null
```

### 4.1.11 查找包含指定字符串的文件内容的文件和文件中该字符串所在行
```sh
find <findPath> -name <fineNameFormat> | xargs grep <findString> 2>/dev/null
```
例：
```sh
find /opt/endeca/ -name "*.xml" | xargs grep "8006" 2>/dev/null
```

### 4.1.12 快速查找文件
```sh
locate *.crx
```

### 4.1.13 更新文建索引
```sh
updatedb
```

### 4.1.14 grep排除指定关键字
```sh
grep -v <keyWords>
```

### 4.1.15 清空一个文件内容
```sh
>aaa.log
```

### 4.1.16 修改linux对虚拟内存swap的使用率
```sh
sudo vi /etc/sysctl.conf
```
```
vm.swappiness=0
```
为0表示让内核尽量使用内存而不是虚拟内存，默认值是60表示当内存占用40%时内核就开始使用虚拟内存
```sh
sudo sysctl -p
```
查看修改的结果
```sh
cat /proc/sys/vm/swappiness
```

### 4.1.17 解压文件
```sh
unzip xxx
```

### 4.1.18 解包文件
```sh
jar xvf beacon.ear storefront.war
jar xvf storefront.war cartridges/navList/navLevelTwoNode.jsp
```

### 4.1.19 打包文件
```sh
jar uvf storefront.war cartridges/navList/navLevelTwoNode.jsp
jar uvf beacon.ear storefront.war
```

### 4.1.20 生成证书
```sh
keytool -genkey -alias taobao -keystore
becn.keystore -storepass 123456
```

### 4.1.21 查看keyStore证书
```sh
keytool -list -v -keystore /opt/jboss/jboss-eap-6.1/standalone/configuration/becn.keystore -storepass 123456
```

### 4.1.22 查看内存占用
```sh
free -h
```
真实可用内存看-/+ buffers/cache:的+即可
比如
```sh
             total       used       free     shared    buffers     cached
Mem:           15G        14G       1.5G       733M       974M       5.5G
-/+ buffers/cache:       7.6G       7.9G
Swap:          15G         0B        15G
```
则此时对应windows的真实可用内存为9.2G

### 4.1.23 查看CPU占用
```sh
top
```
按内存排序，界面上按`Shift+M`
按CPU排序，界面上按`Shift+C`
几个字段含义：
* VIRT: 程序请求大小，但是并不一定全部使用
* RES: 程序真实使用大小

### 4.1.24 查看端口占用
```sh
sudo netstat -tlnp |grep 443
```
不加sudo的话可能显示不出被占用端口的进程号

### 4.1.25 zip压缩文件
打包目录
```sh
zip -r XXX.zip <folder>
```
压缩级别最高
```sh
zip -9r XXX.zip <folder>
```
打包并排除log文件
```sh
zip –r /opt/var.zip /var –x "*.log"
```

### 4.1.26 批量重命名
文件名
```sh
sudo rename aaa/bbb aaa/BBB aaa/*.txt
```
后缀名
```sh
sudo rename .xml_BAK .xml *.xml_BAK
```

### 4.1.27 批量删除文件夹和文件
删除文件夹下的所有 .git 文件
```sh
find . -name ".git" | xargs rm -Rf
```

## 4.2 docker
### 4.2.1 container
#### 4.2.1.1 创建container
```sh
docker rm -f <container name or ID>
```
例：
```sh
#!/bin/bash
containerName=beacon-atg
imageName=acs_atg/111
WORKDIR=/home/terrencewei/workspace/beacon/ACRSProject/docker/scripts/

###############################

sh $WORKDIR/startup-container.sh $containerName "-d --privileged \
-p 4222:22 \
-p 8080:8080 \
-p 8180:8180 \
-p 8280:8280 \
-p 8380:8380 \
-p 8001:8001 \
-p 8002:8002 \
-p 8003:8003 \
-p 8787:8787 \
-p 8788:8788 \
-p 8789:8789 \
-p 8443:8443 \
-p 8543:8543 \
-p 8643:8643 \
--add-host oraclecontainer:172.17.118.38 \
--add-host beacon-oracle:172.17.118.38 \
--add-host endecacontainer:172.18.0.2 \
--add-host beacon-endeca:172.18.0.2 \
--add-host mincron-dev.becn.local:172.17.118.245 \
--add-host localqa.becn.com:172.17.118.245 \
$hosts \
-v /home/terrencewei/workspace/beacon/ACRSProject:/project \
-v /home/terrencewei/docker_home/beacon/jboss/standalone:/opt/jboss/jboss-eap-6.1/standalone \
--name $containerName $imageName"
sleep 2

echo "Change the owner of the folders..."
docker exec $containerName chmod -R 777 /opt/jboss/jboss-eap-6.1/standalone
echo "All finished!!"
exit 0

```

#### 4.2.1.2 将container提交为image
```sh
docker commit -m "<comments>" -a "author" <container ID> <image name>[:<version>]
```
注意这里image name 不能有大写英文字母
例：
```sh
docker commit -m "Install Endeca and update some evn variables" -a "Terrence Wei" 86a3b8938511 smp-dev
```

#### 4.2.1.3 删除container
```sh
docker rm -f <container name or ID>
```
例：
```sh
docker rm -f smp-developer2
```

#### 4.2.1.4 导出container
```sh
docker export <CONTAINER ID> > XXX.tar
```

#### 4.2.1.5 导入container为image
```sh
cat XXX.tar.tar | docker import - <container name>:latest
```

#### 4.2.1.6 查看所有container
```sh
docker ps -a
```

#### 4.2.1.7 查看已运行container
```sh
docker ps
```

#### 4.2.1.8 查看日志
```sh
docker logs <container name or ID>
```

#### 4.2.1.9 删除image
```sh
docker rmi <image name>
```

#### 4.2.1.10 导出image
```sh
docker save <image name> > XXX.tar
```

#### 4.2.1.11  导入image
```sh
docker load < XXX.tar
```

#### 4.2.1.12 重启docker服务
```sh
sudo service docker restart
```

# 5 SVN and Git
## 5.1 SVN
### 5.1.1 svn st
`svn status`的简写

### 5.1.2 svn up
`svn update`的缩写

### 5.1.3 svn commit
```sh
svn commit -m "xxxx"
```

### 5.1.4 svn changelist用法
[详见](http://www.letuknowit.com/archives/usage-of-svn-changelist/)
```sh
svn cl <change list name> <file name and path>
```
将文件从change list移除
```sh
svn cl --remove <file name and path>
```

### 5.1.5 Eclipse里用change set方法
[详见](http://stackoverflow.com/questions/8406592/eclipse-subversive-commit-changelist)

1. go in the Synchronize view
2. click the Show Change Sets button
3. you can then add changed files to change sets (and create new change sets) from the right-click menu.

## 5.2 Git
### 5.2.1 创建并切换分支
```sh
git checkout -b feature/sprint-0-develop
```

### 5.2.2 查看当前分支状态
开头带remote的是远程分支
```sh
git status
```

### 5.2.3 将本地与远程仓库分支关联
```sh
git branch --set-upstream-to=origin/feature/develop-sprint-1 feature/develop-sprint-1
```

### 5.2.4 新建本地分支并与远程分支关联
```sh
git checkout -b feature/develop-sprint-1 origin/feature/develop-sprint-1
```

### 5.2.5 查看当前有哪些分支
```sh
git branch
```

### 5.2.6 查看当前分支与远程分支关联的状态
```sh
git branch -vv
```

### 5.2.7 更新远程分支信息到本地
```sh
git fetch
```

### 5.2.8 回复某个文件的更改？
1. 在eclipse删除该文件
2. `git reset`
3. `git checkout <文件名>`

### 5.2.9 恢复当前代码到某个commit版本
只取消commit这个操作不回退代码
```sh
git reset --soft <commitID前6位>
```
取消commit并且回退所有代码改动
```sh
git reset --hard <commitID前6位>
```

### 5.2.10 git status中忽略文件权限或文件拥有者的改变
所有库
```sh
git config --global core.fileMode
```
当前库
```sh
git config core.fileMode false
```

### 5.2.11 下载更新代码
将当前分支关联的远程分支代码fetch并merge
```sh
git pull
```

### 5.2.12 将当前分支与远程分支xxx fetch并merge
```sh
git pull origin <branch name>
```

### 5.2.13 下载代码时不根据系统自动替换换行符
```sh
git config --global core.autocrlf false
```

### 5.2.14 清除没有版本的文件和目录
```sh
git clean -fd
```

### 5.2.15 查看将要清除哪些没有版本的文件和目录
```sh
git clean -nfd
```

### 5.2.16 忽略文件版本跟踪
* 对于未添加到git版本库的文件，可以写在.gitignore里
* 对于已经有版本的文件：
忽略跟踪：
```sh
git update-index --assume-unchanged .gitignore
git update-index --assume-unchanged ACRSProject/.classpath
git update-index --assume-unchanged ACRSProject/docker/common.properties
git update-index --assume-unchanged ACRSProject/docker/scripts/2-StartEndecaContainer.sh
git update-index --assume-unchanged ACRSProject/docker/scripts/3-StartATGContainer.sh
git update-index --assume-unchanged ACRSProject/scripts/start-script.properties
```
查看哪些文件被手动忽略跟踪过：
```sh
git ls-files -v | grep -v 'H '
```
恢复跟踪：
```sh
git update-index --no-assume-unchanged <file path>
```

### 5.2.17 忽略ssl证书验证
```sh
git config --global http.sslVerify false
```

### 5.2.18 查看远程仓库
```sh
git remote -vv
```

### 5.2.19 增加远程仓库
```sh
git remote add <name> <url>
```
比如:
```sh
git remote add aaxis-beacon-stash ssh://git@stash.aaxisgroup.net:7999/br/beacon.git
```

### 5.2.20 推送到指定远程仓库
推送本地所有分支
```sh
git push --all aaxis-beacon-stash
```
推送指定分支
```sh
git push <远程主机名> <本地分支名>:<远程分支名>
```

### 5.2.21 重新设定远程仓库remote url
```sh
git remote set-url origin ssh://terrencewei@stash.aaxisgroup.net/scm/br/beacon.git
```

### 5.2.22 从github下载最新git源码自己编译安装git
```sh
git clone https://github.com/git/git
```

#### 5.2.22.1 为当前用户安装git:
```sh
make
make install
sudo chmod -R 777 ~/share
sudo chmod -R 777 ~/lib
sudo chmod -R 777 ~/libexec
```
#### 5.2.22.2 为所有用户安装git:
```sh
make prefix=/usr/local all doc info ;
sudo chmod -R 777 /usr/local/bin
```
#### 5.2.22.3 添加环境变量更改/etc/profile:
引入tab键自动补全词典:
```sh
sudo vi /etc/profile
source /home/terrencewei/workspace/git/contrib/completion/git-completion.bash
source vi /etc/profile
```
#### 5.2.22.4 如果提示缺少package,则尝试安装：
#### 5.2.22.5 安装openssl:
```sh
sudo apt-get install openssl
sudo apt-get install libssl-dev
```
#### 5.2.22.6 安装curl:
```sh
sudo apt-get install curl
sudo apt-get install libcurl4-openssl-dev
```
#### 5.2.22.7 安装expat:
```sh
sudo apt-get install libexpat1-dev
```

### 5.2.23 查看远程仓库remote地址
```sh
git remote -vv
```

### 5.2.24 更改远程仓库remote地址
```sh
git remote set-url origin https://terrencewei@stash.aaxisgroup.net/scm/br/beacon.git
git remote set-url origin ssh://git@stash.aaxisgroup.net:7999/br/beacon.git
```

### 5.2.25 revert commit
```sh
git revert <commit ID>
```
这样会产生一个逆向commit提交

### 5.2.26 查看所有分支
```sh
git branch -a
```

### 5.2.27 查看所有远程分支
```sh
git branch -r
```

### 5.2.28 删除本地在远程仓库不存在的分支
```sh
git remote update origin --prune
```

### 5.2.29 git rebase/squash commit 合并commit
[详见](http://blog.csdn.net/yangcs2009/article/details/47166361)

编辑最新的四次提交信息
```sh
git rebase -i HEAD~4
```
这时列出的commit list时间顺序是从上到下越来越新, 最下的是最新

修改想合并的commit前p改为s

这时该次提交会被合并到上面的commit

比如:

修改前:

option | commit comments
---|---
pick | aaa
pick | bbb
pick | ccc

改为
option | commit comments
---|---
pick | aaa
s | bbb
s | ccc

即是将bbb和ccc一起合并改动到aaa
继续rebase
```sh
git rebase --continue
```
全部完成后，在编辑comments界面，把不想要的comments注释掉，前加#
或者放弃rebase
```sh
git rebase --abort
```
最后强制推送结果到remote:
```sh
git push -f
```

### 5.2.30 将某次commit提交到另一个分支
先checkout到欲提交的分支,再:
```sh
git cherry-pick <commit id>
```
就相当于改动并且`git add`, `git commit`
解决完冲突(如果有的话)用console里提示的语句commit:
```sh
 git commit -c xxxxxx
 ```
之后直接push

Git从1.7.2版本开始支持批量cherry-pick
```sh
git cherry-pick <start-commit-id>^..<end-commit-id>
```

### 5.2.31 通过ssh协议git clone
#### 5.2.31.1 创建个人ssh key
```sh
cd ~/.ssh
ls id_*
```
如果已经有key了，则直接跳往使用key

备份旧key
```sh
mkdir key_backup
cp id_rsa* key_backup
```

生成key
```sh
ssh-keygen -t rsa -C "terrencewei@aaxischina.com"
```

#### 5.2.31.2 使用个人ssh key
```sh
sudo apt-get install xclip
xclip -sel clip < ~/.ssh/id_rsa.pub
```
此时key已经被复制到剪贴板中

1. 登录[stash](https://stash.aaxisgroup.net/projects/BR/repos/beacon/browse)
2. 点击右上角人物头像，选Manage  account
3. 点击SSH keys
4. 点击Add key
5. 将刚才复制到剪贴板中的key粘贴进来
6. 回到stash,左侧点击...图标,Actions里点clone,此时发现clone类型变为SSH,复制其中内容,切换到worksapce执`行git clone`即可.

### 5.2.32 将文件从git版本控制中移除
[详见](http://www.tuicool.com/articles/NfEzeq)
```sh
git rm -r -n --cached "bin/" //预览待删文件列表
git rm -r --cached  "bin/" //执行git rm
```
之后commit和push即可

## 5.3 Github
### 5.3.1 下载一个repository
Gitub页面上选择'Clone or Download', 选择https

复制后转到本地要存放code的文件夹，执行git clone
例：
```sh
mkdir -p /home/terrencewei/workspace/SMP/smp_Docker_Github
cd /home/terrencewei/workspace/SMP/smp_Docker_Github
git clone https://github.com/sheetmusicplus/atg-docker.git
```
输入Github的用户名和密码

### 5.3.2 查看分支
```sh
git branch
git branch -r
git branch -a
```

### 5.3.3 创建本地分支
```sh
git checkout -b <branch name>
```

### 5.3.4 推送本地分支到Github
```sh
git push origin <branch name>
```

### 5.3.5 删除本地分支
```sh
git branch -d <branch name>
```

### 5.3.6 删除远程分支
```sh
git push origin :<branch name>
```
分支名前的冒号代表删除

### 5.3.7 http方式push大文件加buffer size
```sh
git config http.postBuffer 524288000
```
限制单文件最大为500MB
否则会出现POST git-receive-pack (chunked)卡主不动的问题，是GIT的一个bug

# 6 Ubuntu
## 6.1 /etc/profile
```sh
########## terrence wei custom start ##########

# java
export JAVA_HOME=/home/terrencewei/develop/jdk1.8.0_121
export PATH=$JAVA_HOME/bin:/home/terrencewei/develop/lib/nodejs/node-v6.10.0-linux-x64/bin:$PATH
export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar
# git
source /home/terrencewei/workspace/github/git/contrib/completion/git-completion.bash
# custom command in terminal
source /etc/bash.bashrc
# display screen for GUI app
export DISPLAY=:0.0

########## terrence wei custom end ##########
```

## 6.2 /etc/bash.bashrc
```sh
########## terrence wei custom start ##########

#alias wine='/home/terrencewei/workspace/wine/wine'
#alias node='/home/terrencewei/develop/lib/nodejs/node-v6.10.0-linux-x64/bin/node'
#alias npm='/home/terrencewei/develop/lib/nodejs/node-v6.10.0-linux-x64/bin/npm'
alias sh='/bin/bash'

########## terrence wei custom end ##########
```

## 6.3 设置
### 6.3.1 terminal终端背景色
```
#300a24
```

RGB=48,10,36

font=Ubuntu Mono,13

### 6.3.2 配置系统各种设置参数
unity-tweak-tool

### 6.3.3 Ubuntu配置开机启动项
搜索框里输入
gnome-session
可执行程序位于/usr/bin/下

### 6.3.4 Ubuntu开机启动项(服务)
查看
```sh
sudo service --status-all
sudo initctl list
```
管理
```sh
sudo sysv-rc-conf
```

### 6.3.5 Ubuntu环境变量java
```sh
export JAVA_HOME=/home/terrencewei/develop/jdk1.7.0_15
export JRE_HOME=${JAVA_HOME}/jre
export CLASSPATH=.:${JAVA_HOME}/lib:${JRE_HOME}/lib
export PATH=${JAVA_HOME}/bin:$PATH
```

### 6.3.6 如何定制Ubuntu Unity桌面右上角面板的时间日期显示格式
[详见](http://os.51cto.com/art/201512/502414.htm)

Ubuntu软件中心

安装dconf Editor
com -> canonical -> indicator -> datetime
time-format:custom
custom-time-format
```
%Y-%m-%d (%a) %t%l:%M%t%p%t%t%Z%t%b%t
```
终端输入man date获取更多帮助

### 6.3.7 显示搜狗输入法配置
搜索里输入fcitx

## 6.4 软件
### 6.4.1 安装软件
```sh
dpkg -i XXX.deb
```

### 6.4.2 查找已安装软件
```sh
dpkg --get-selections | grep XXX
```

### 6.4.3 卸载已安装软件
保留配置文件
```sh
dpkg -r XXX 或 apt-get remove XXX
```
不保留配置文件
```sh
dpkg -P XXX 或 apt-get --purge remove XXX
```

### 6.4.4 安装GIT-GUI
```sh
sudo apt-get install git-gui
```
运行
`Alt+F2`,输入`git gui`

### 6.4.5 安装Chrome浏览器
```sh
wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
sudo dpkg -i google-chrome-stable_current_amd64.deb
```
#### 6.4.5.1 打包Chrome Extensions
settings-extensions界面

选择developer mode

选pach extension, 路径选
```
/home/terrencewei/.config/google-chrome/Default/Extensions/
```
下的一个插件下的版本号文件夹
点击后即可打包生成.crx文件, 位置在版本号文件夹同级

### 6.4.6 安装截图和编辑工具shutter
ubuntu软件中心

搜索 shutter

设置shutter快捷键
System settings-->keybord-->shortcuts-->Custom Shortcuts-->add-->Command is "shutter -s"-->click "disable"-->Enter Ctrl+Alt+A

### 6.4.7 用shadowsocks翻墙
1. 安装pip
```sh
wget https://bootstrap.pypa.io/get-pip.py  --no-check-certificate
sudo python get-pip.py
```

2. 安装shadowsocks
```sh
sudo pip install shadowsocks
```

3. 安装shadowsocks-Qt5 GUI
```sh
sudo add-apt-repository ppa:hzwhuang/ss-qt5
sudo apt-get update
sudo apt-get install shadowsocks-qt5
```
或者自己启用sslocal服务
```sh
shsslocal -c /home/terrencewei/develop/vpn/shadowsocks/shadow.json
```
shadow.json
```json
{
    "server":"XXXXX",
    "server_port":XXXXX,
    "local_address": "127.0.0.1",
    "local_port":1081,
    "password":"XXXX",
    "timeout":600,
    "method":"rc4-md5",
    "fast_open": true,
    "workers": 1
}
```

4 .浏览器安装代理软件
firefox安装FoxyProxy
设置ip与shadowsocks GUI里填的一致
比如填127.0.0.1 端口1080
协议选socket v5
Chrome安装Proxy SwitchyOmega

或者启用PAC全局代理
sudo pip install genpac
新建文件/home/terrencewei/develop/vpn/pac/pac-config.txt
```
[config]
;means comments
;proxy = "SOCKS5 127.0.0.1:9527; SOCKS 127.0.0.1:9527"
proxy = SOCKS5 127.0.0.1:1080
gfwlist-proxy = SOCKS5 127.0.0.1:1080
;gfwlist-url = https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt
gfwlist-local = /home/terrencewei/develop/vpn/pac/pac-gfwlist.txt
;update-gfwlist-local = false
;compress = false
;base64 = false
;user-rule-from = /home/terrencewei/develop/vpn/pac/pac-user-rules.txt
output = /home/terrencewei/develop/vpn/pac/pac-autoproxy.pac
```
```sh
cd /home/terrencewei/develop/vpn/pac
genpac -c /home/terrencewei/develop/vpn/pac/pac-config.txt
```
之后在Ubuntu:
System settings > Network > Network Proxy ;

选择 Method 为 Automatic

设置 Configuration URL 为
```
/home/terrencewei/develop/vpn/pac/pac-autoproxy.pac
```
点击 Apply System Wide。

即将系统设置为全局PAC代理

### 6.4.8 Ubuntu软件中心无法安装或者卸载软件
首先把下列加到start up里：
```sh
/usr/lib/policykit-1-gnome/polkit-gnome-authentication-agent-1
```
不想重启的话直接运行：
```sh
gksu /usr/lib/policykit-1-gnome/polkit-gnome-authentication-agent-1
```

所有已安装软件图标的快捷方式位置
```sh
/usr/share/applications
```

### 6.4.9 Docker
1. Install Docker:
```sh
curl -sSL https://get.daocloud.io/docker | sh
```

2. Use docker command in terminal without using 'sudo':
```sh
sudo groupadd docker
sudo gpasswd -a ${USER} docker
sudo service docker restart
restart your computer
```

3. Alter hosts:
```sh
172.17.3.91 docker.aaxisaws.com
```

### 6.4.10 Skype 4.3 (linux版)
1. 删除旧版skype
`Ctrl+Alt+T`
```sh
sudo apt-get remove skype skype-bin
rm -rf ~/.skype
```

2. 设置download source list
```sh
System settings-software-Canoical Partners and Canoical Partners(Source Code)
```

3. 安装skype
`Ctrl+Alt+T`
```sh
sudo apt-get update
sudo apt-get install skype
```

### 6.4.11 Skypeforlinux alpha
skypeforlinux-64-alpha-1.3.deb

[download by page](https://www.skype.com/en/download-skype/skype-for-linux/downloading-web/?type=weblinux-deb)

[download by url](https://repo.skype.com/latest/skypeforlinux-64-alpha.deb)

### 6.4.12 在ternimal下用wget下载:
```sh
wget https://repo.skype.com/latest/skypeforlinux-64-alpha.deb
```
### 6.4.13 安装deb
```sh
sudo dpkg -i skypeforlinux-64-alpha.deb
```

### 6.4.14 WinMerge类似的文件对比工具
Ubuntu软件中心搜索并Meld安装

### 6.4.15 SecureCRT
绿色免安装版程序本体：
scrt-8.0.3.1183.ubuntu14-64.tar.gz直接解压即可
hack:
```sh
sudo perl securecrt_linux_crack.pl /home/terrencewei/develop/scrt-8.0.3/SecureCRT
```
license date:
```
License:
Name:    xiaobo_l
Company:    www.boll.me
Serial Number:    03-15-097355
License Key:      AC81ET 9RKAWY 6WP69G 8EQ1JB ABCM3D K4E85M D3WG57 RGFWT2
Issue Date:    8/16/2015
```
创建快捷方式：
```sh
sudo vi /usr/share/applications/SecureCRT.desktop
```
```
[Desktop Entry]
Name=SecureCRT
Comment=SecureCRT provides remote access using SSH2, SSH1, Telnet, Serial, and other protocols.
Exec=/home/terrencewei/develop/scrt-8.0.3/SecureCRT
Icon=/home/terrencewei/develop/scrt-8.0.3/securecrt_64.png
StartupNotify=true
Terminal=false
Type=Application
Categories=Network;
Actions=Window;
[Desktop Action Window]
Name=New Window
Exec=SecureCRT
OnlyShowIn=Unity;
```
[old参考：](https://www.boll.me/archives/680#comment-2421)
```
wget http://download.boll.me/securecrt_linux_crack.pl

用ubuntu软件中心安装的secureCRT:
sudo perl securecrt_linux_crack.pl /usr/bin/SecureCRT
```

### 6.4.16 官网下载编译和安装GIT
1. 先安装ubuntu自带的低版本git:
```sh
sudo apt-get install git
```
2. 下载git源码:
```sh
mkdir -p ~/workspace/
git clone https://github.com/git/git
```
3. 查看README.md点击INSTALL查看官方安装指导

4. 安装到ubuntu的当前user:
```sh
sudo make
sudo make install
```

安装到ubuntu的所有user:
```sh
sudo make prefix=/usr/local all doc info ;
sudo make prefix=/usr/local install install-doc install-html install-info ;
```

*make编译如果出错,需要搜索安装各种依赖包,比如libssl-dev, libcurl4-openssl-dev 和 libexpat1-dev*

5. 添加环境变量更改`/etc/profile`:
引入tab键自动补全词典:
```sh
source /home/terrencewei/workspace/git/contrib/completion/git-completion.bash
```

### 6.4.17 创建快捷方式
```sh
sudo vi /usr/share/applications/XXX.desktop
```
```
[Desktop Entry]
Name=XXX
Comment=YYYYYYY
Exec=<app path>
Icon=<app icon image path>
StartupNotify=true
Terminal=false
Type=Application
Categories=Application;
```


### 6.4.18 Ubuntu打开超链接总是在chrome打开空白页
[详见](https://segmentfault.com/q/1010000007283953)

`~/.local/share/applications/`
目录里也有google-chrome.desktop文件, 浏览器会优先使用.local下的配置, 需要在修改Exec的设置

```
Exec=/opt/google/chrome/chrome %U
```
现在点击链接不会再弹出空白页啦~

我是直接删掉了~/.local/share/applications/的google-chrome.desktop文件，一切正常

### 6.4.19 Chrome更新flash
首先确保系统已翻墙
打开Chrome输入`chrome://components/`
找到Adobe Flash Player
点击Check for update即可

### 6.4.20 Firefox更新flash
[下载](https://get.adobe.com/flashplayer/)flash包.tar.gz
解压后
```sh
cp libflashplayer.so /usr/lib/mozilla/plugins/
```
重启FireFox即可

### 6.4.21 安装Wine
```sh
git clone git://source.winehq.org/git/wine.git
```
or
```sh
git clone https://github.com/wine-mirror/wine.git
```
32位系统:
```sh
./configure
make
```
64位系统:
```sh
./configure --enable-win64
```
之后:
```
make
make install
```
即可安装完成

安装过程中的trouble shooting:
```

configure: error: no suitable flex found. Please install the 'flex' package.
sudo apt-get install flex
sudo apt-get install bison

sudo apt-get install libfreetype6-dev
sudo apt-get install libpng-dev
sudo apt-get install libx11-dev
sudo apt-get install libxrender-dev
sudo apt-get install libxml2-dev
sudo apt-get install libxslt-dev
sudo apt-get install libjpeg-dev

libpng:
./configure --prefix=/usr/local/bin/libpng
make check
make install

sudo apt-get install libpng-dev
sudo apt-get install libx11-dev

sudo chmod -R 777 /usr/local/bin
sudo chmod -R 777 /usr/local/share


sudo apt-get install winbind
sudo apt-get install libfreetype6
```


## 6.5 环境
### 6.5.1 fatal error: openssl/ssl.h: No such file or directory
```sh
sudo apt-get install openssl
sudo apt-get install libssl-dev build-essential zlibc zlib-bin libidn11-dev libidn11
```

### 6.5.2 fatal error: curl/curl.h: No such file or directory
安装libcurl-dev:
```sh
sudo apt-get install libcurl4-openssl-dev
```
or
```sh
sudo apt-get install libcurl4-gnutls-dev
```
如果提示依赖问题, 需要一直安装提示的所需依赖包,

直到某一个包里提示我:

libcomerr2需要的版本是1.42.9-3ubuntu1.2但是我已经安装的是1.42.9-3ubuntu1.3

所以需要对这个包进行降级:
```sh
sudo apt-get install libcomerr2=1.42.9-3ubuntu1.2
```
之后,再安装libcurl-dev即可

### 6.5.3 fatal error: expat.h: No such file or directory
```sh
sudo apt-get install libexpat1-dev
```

# 7 Web前端
## 7.1 jsp
### 7.1.1 jsp页面form bean里的参数都会去调用一次后台的同名set方法
比如jsp里：
```html
<dsp:input type="hidden" bean="CartModifierFormHandler.removeItemFromOrder" value="" priority="-10"/>
```
如果这时在form handler里恰好有一个public方法，方法名也叫setRemoveItemFromOrder
那么jsp的该表单提交前都会去调一道这些set方法
### 7.1.2 一些js不起作用
很可能是jboss启动或者页面刷新时后台显示某个jsp报错，block住了后续功能
### 7.1.3 点击浏览器前进或者后退键的时候 触发某些操作
因为浏览器里有back-forward-cache存在,点击前进或者后退的时候读的是内存中页面的缓存
所以需要一些方法来触发
### 7.1.4 JSTL and EL
#### 7.1.4.1 c标签库
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
##### 7.1.4.1.1 forEach标签
当items为一个map时，var获取的是该Map.Entry
```java
// retrieves an iterator over the Map.Entry items in a Map
protected ForEachIterator toForEachIterator(Map m) {
    return new SimpleForEachIterator(m.entrySet().iterator());
}
```
因此Entry里有`getKey()`和`getValue()`方法，页面上可以用`item.key`和`item.value来`获取Map的key和value
forEach的源码对应`/org/apache/taglibs/standard/tag/common/core/ForEachSupport.java`
当items为一个数组时，
如果你迭代的是一个list<User>这样的自定义对象的list，那么这时候item会得到一个object，而且该object是一个object【】类型，也就是说，会将list里面的每个user对象的属性值get出来，作为一个object再存放到i所引用的那个object里面去，说到这里，大家就应该明白了，其实该标签在处理list<User>类型的集合的展现问题的时候，是简单的将该集合中的每个具体对象的属性值取出来封装成一个个的object，然后放入item这个object数组中去的，所以，我们在前台jsp页面上展现的时候不能使用$(item.userName)这样的方法来得到对应的值，否则会报Java.lang.NumberFormatException: For input string: "userName" 这样的异常的，原因就是因为返回的item是一个object的数组，$(item.userName)这种访问方式是不能用来访问数组的，否则在处理的时候jsp引擎会先将userName这个字符串转换成int以确定数组下标，而在转换的时候就会出现字符串“userName”无法转换成int的异常了。
那么我们该怎么取值呢，应该是一下标来访问数组，也就是item【0】，item【1】，这样的方式，这样渠道的值分别是我们User对象的按照定义先后顺序的各个属性值了。
##### 7.1.4.1.2 catch标签
可以捕获异常，防止一些exception从页面抛出来
### 7.1.5 functions标签库
```html
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
${fn:xxx}
```
### 7.1.6 param不是JSP的内置对象, 是EL中的
`${param.name}`等价于`request.getParameter("name")`，`${param[name]}`也是一样的
`${params.name}`等价于`request.getParameterValues（"name"）`
注意：
1. `${requestScope.name}` 等价于 `request.getAttribute("name")`
2. 上面没有指出从哪个scope中取，所以按顺序检测那四个scope
3. 最好用`${xxsScope.name}` ，不用 `${param.name}`
## 7.2 jQuery
### 7.2.1 <select>
例如现在有一个<select>为：
```html
<select>
  <option value="1">aaa</option>
  <option value="2">bbb</option>
  <option value="3">ccc</option>
</select>
```
设置value为1的option项被选中
`$("#mySelect").val("1");`
设置text为aaa的项选中
```javascript
// this expression below didn't work in jQuery 1.11
$("#mySelect").find("option[text='aaa']").attr("selected",true);
// use below instead?
$("#mySelect").find("option:contains('aaa')").attr("selected",true);
```
### 7.2.2 动态元素事件绑定
http://blog.csdn.net/u012800044/article/details/41555361
举个例子，假设我们有这样一个页面：
```html
<html>
<head>
<script>
$(document).ready(function(){
	$('button').click(function(){
		$('ol').append('<li><a href="#">动态增加的节点</a></li>');
	});
});
</script>
</head>
<body>
<ol>
  <li>
    <a href="#">静态节点连接</a>
  </li>
</ol>
<button>增加节点</button><pre name="code" class="html">// 简单粗暴，直接绑定到DOM对象
$(document).on('click', 'a', function(){
    alert( $(this).text() );
    return false;
});
```
jQuery > 1.7.0 - 使用 .on() 事件绑定方法
如果你项目中使用的jQuery版本高于1.7.0，那么推荐使用 .on() 方法，这个方法能够直接绑定和代理事件。根据我们要实现的需求，我们需要使用代理事件来解决问题，
也就是说我们**把事件的绑定交给父级元素**，如何使用选择器去实现事件绑定，来看一下代码：
```javascript
//正确的做法
$('ol').on('click', 'a', function(){
    alert( $(this).text() );
});
```
我们是首先把事件绑定到父级元素/或者说是容器，再通过类选择器找到"a"元素，然后把事件传递到动态创建的子元素上。
**我们必须要把事件绑定放到父级**，不然像下面这样的代码是不得行的：
```javascript
//这样的代码是不行的
$('a').on('click', function(){
    alert( $(this).text() );
});
```
如果是单个事件的绑定，那推荐使用这种事件绑定方法，这样能够很好的提升性能。
如果你不知道父类元素，你甚至可以绑定到 document 对象，不过这样绑定像click这样的简单事件还行，换成是mousemove那可能对性能就有比较大的影响
```javascript
// 简单粗暴，直接绑定到DOM对象
$(document).on('click', 'a', function(){
    alert( $(this).text() );
});
```
更多关于 .on() 方法的介绍，请看官方说明http://api.jquery.com/on/
### 7.2.3 元素定位 .position()
[详见](http://www.runoob.com/jqueryui/api-position.html)
```js
$(window).on("resize.ps.account", function() {
    if($(window).width() >= 768){
        $(".switch-account").position({
            my: 'left-6 top-9',
            at: 'left bottom',
            of: ".account-ctrl"
        });
    } else {
        $(".switch-account").css({
            'position': '',
            'top': '',
            'left': ''
        });
    }
});
```
### 7.2.4 add load event listener to window onload:
```js
function addLoadEvent(functionName) {
    if (window.addEventListener) {
        window.addEventListener('load', function() {
            $(window).trigger(functionName);
        });
    } else if (window.attachEvent) {
        window.attachEvent('onload', function() {
            $(window).trigger(functionName);
        });
    } else {
        if (typeof window.onload === 'function') {
            (function() {
                var oldWindowOnload = window.onload;
                window.onload = function() {
                    oldWindowOnload();
                    $(window).trigger(functionName);
                };
            })();
        } else {
            window.onload = function() {
                $(window).trigger(functionName);
            };
        }
    }
}
addLoadEvent("myFunction");
$(window).on("myFunction", function() {
    // your code here...
});
```
### 7.2.5 筛选同级元素
```js
.siblings(...)
```
### 7.2.6 发送post并跳转
```js
BCSendPost:function(url,args){
    var body = $(document.body),
        form = $("<form method='post'></form>"),
        input;
    form.attr({"action":url});
    $.each(args,function(key,value){
        input = $("<input type='hidden'>");
        input.attr({"name":key});
        input.val(value);
        form.append(input);
    });
    form.appendTo(document.body);
    form.submit();
    //document.body.removeChild(form[0]);
    form.remove();
}
```
## 7.3 js
### 7.3.1 轮播插件
#### 7.3.1.1 Beacon项目用的是Ow Carousel
[owl.cauousel.js](http://www.owlcarousel.owlgraphic.com/)
#### 7.3.1.2 slick.js
SMP项目用的是[slick.js](http://github.com/kenwheeler/slick)
### 7.3.2 AJAX
ajax实现原理是通过XMLHttpRequest对象实现:
在不重新加载页面的情况下更新网页
在页面已加载后从服务器请求数据
在页面已加载后从服务器接收数据
在后台向服务器发送数据
### 7.3.3 gulp压缩合并：
有一些js语法错误可能会导致编译不过
但是浏览器又解析正常, 比如Chrome
所以在严格格式下js写法要注意
### 7.3.4 on事件绑定一定要确保只绑定一次!
否则会造成双击问题!!
## 7.4 css
### 7.4.1 分辨率选择器
```css
@media (max-width: 767px)
```
表示小于等于767px的屏幕
多个max-width时要从大到小，从上到下写
即：
```css
@media (max-width: 767px)
@media (max-width: 480px)
@media (max-width: 767px)
```
min-witdh表示大于等于xxx
多个min-width时要从小到大，从上到下写
### 7.4.2 多类选择器
有空格表示后代，没有空格表示同级
比如：
```html
<div class="a b">
  <span class="c">
  </span>
</div>
```
要想选到c，则：.a与.b间没有空格表示选择多类，与.c有空格则表示c是ab的子类
```css
.a.b .c {
 xxx
}
```
### 7.4.3 文字过长自动替换成省略号和换行
```css
$text.css("width",$parentContainer.width());
$text.css("white-space","nowrap");
$text.css("text-overflow","ellipsis");
$text.css("overflow","hidden");
```
### 7.4.4 相邻兄弟选择器
+号
比如:
```css
btn+btn
```
表示并列的两个btn元素
### 7.4.5 水平居中不生效
用table包围即可
```html
<table width="100%" height="100%"><tr><td align="center">要居中的元素</td></tr></table>
```
## 7.5 http
### 7.5.1 请求header
* Accept ：客户端指出响应可以接受的媒体类型
* Accept-Charset ：客户端指出响应可以接受的字符集
* Accept-Encoding ：客户端指出响应可以接受的字符编码
* Accept-Language ：客户端指出允许的语言
* Authorization ：客户端在受到401 后，需要向服务器标明身份，包括此header 即可
* Expect : 客户端指出要求的特殊服务器行为。若服务器无法满足，可以返回417
### 7.5.2 <form>表单
action属性指定了该form要被提交到哪里，可以相对路径也可以绝对路径
### 7.5.3 <form>表单post提交
一个<form>间的
```html
<input name="xxx" value="yyy".../>
```
则后台request中，
Post Parameters里就会有：xxx=yyy
如果在页面中有重名的name的input，则后台Post Parameters里以第一个的值为准
比如：
```html
<input name="xxx" value="yyy".../>
<input name="xxx" value="zzz".../>
```
则后台request中，Post Parameters里：xxx=yyy
### 7.5.4 post request相关知识:
[详见](http://stackoverflow.com/questions/14551194/how-are-parameters-sent-in-an-http-post-request)
In an HTTP GET request, parameters are sent as a query string:
http://example.com/page?parameter=value&also=another
In an HTTP POST request, the parameters are not sent along with the URI.
My question is, where are the values? In the request header?
 In the request body? What does it look like?
 ***
in POST requests, values are sent in the "body" of the request.
With web-forms they are most likely sent with a media type of application/x-www-form-urlencoded or multipart/form-data.
Programming languages or frameworks which have been designed to handle web-requests
usually do "The Right Thing™" with such requests
and provide you with easy access to the readily decoded values
 (like $_REQUEST or $_POST in PHP, or cgi.FieldStorage(), flask.request.form in Python).
 ***
The values are sent in the request body, in the format that the content type specifies.
Usually the content type is application/x-www-form-urlencoded, so the request body uses the same format as the query string:
parameter=value&also=another
When you use a file upload in the form, you use the multipart/form-data encoding instead,
which has a different format. It's more complicated, but you usually don't need to care what it looks like,
so I won't show an example, but it can be good to know that it exists.
## 7.6 bootstrap
### 7.6.1 响应式工具
[详见](http://v3.bootcss.com/css/#responsive-utilities)
- | 超小屏幕手机 (<768px) 0px~767px| 小屏幕平板 (≥768px) 768px~991px| 中等屏幕桌面 (≥992px) 922px~1199px| 大屏幕桌面 (≥1200px) 1200px~max
---|---|---|---|---
.visible-xs-* |  可见 | 隐藏 | 隐藏 | 隐藏
.visible-sm-* |  隐藏 | 可见 | 隐藏 | 隐藏
.visible-md-* |  隐藏 | 隐藏 | 可见 | 隐藏
.visible-lg-* |  隐藏 | 隐藏 | 隐藏 | 可见
.hidden-xs | 隐藏 | 可见 | 可见 | 可见
.hidden-sm | 可见 | 隐藏 | 可见 | 可见
.hidden-md | 可见 | 可见 | 隐藏 | 可见
.hidden-lg | 可见 | 可见 | 可见 | 隐藏

### 7.6.2 栅格系统
- | 超小屏幕手机 (<768px) 0px~767px| 小屏幕平板 (≥768px) 768px~991px| 中等屏幕桌面 (≥992px) 922px~1199px| 大屏幕桌面 (≥1200px) 1200px~max
---|---|---|---|---
栅格系统行为 |  总是水平排列 | 开始是堆叠在一起的，当大于这些阈值时将变为水平排列C | 同左 | 同左
.container 最大宽度 |  None （自动） | 750px | 970px | 1170px
类前缀 |  .col-xs- | .col-sm- | .col-md- | .col-lg-
列（column）数 |  12 | 同左 | 同左 | 同左
最大列（column）宽 | 自动 | ~62px | ~81px | ~97px
槽（gutter）宽 | 30px （每列左右均有 15px） | 同左 | 同左 | 同左
可嵌套 | 是 | 同左 | 同左 | 同左
偏移（Offsets） | 是 | 同左 | 同左 | 同左
列排序 | 是 | 同左 | 同左 | 同左

注意,栅格系统默认最大只有12列，如果某一个div指定的样式大于了12，则该div就会自动占满一行，后续div就会被挤到下一行里
比如：
```html
<div class="col-md-8">AAA</div>
<div class="col-md-4">BBB</div>
```
效果：
```html
A A A
BBB
```
如果改为大于等于12:
```html
<div class="col-md-12或者更大">AAA</div>
<div class="col-md-4">BBB</div>
```
效果：
```html
A  A  A
BBB
```
该AAA就会占满一行
该BBB会被挤到第二行，相当于一个row了
也即：
```html
<div class="row">
    <div class="col-md-13">AAA</div>
    <div class="col-md-4">BBB</div>
    <div class="col-md-4">CCC</div>
</div>
```
效果：
```html
A   A   A
BBB CCC
```
等价于：
```html
<div class="row">
    <div class="col-md-12">AAA</div>
</div>
<div class="row">
    <div class="col-md-4">BBB</div>
    <div class="col-md-4">CCC</div>
</div>
```
效果：
```html
A   A   A
BBB CCC
```
## 7.7 nodejs,自带npm
### 7.7.1 安装
#### 7.7.1.1 下载编译好的node的包
[node-v6.10.0-linux-x64.tar.xz](https://nodejs.org/en/)

解压
```
cd /home/terrencewei/develop/lib/nodejs/node-v6.10.0-linux-x64/bin
```

将node转为全局命令:
```
sudo ln -s /home/terrencewei/develop/lib/nodejs/node-v6.10.0-linux-x64/bin/node /usr/local/bin/node
sudo ln -s /home/terrencewei/develop/lib/nodejs/node-v6.10.0-linux-x64/bin/npm /usr/local/bin/npm
```
#### 7.7.1.2 或者自己编译源码
```
tar xvf node-v0.10.28.tar.gz
cd node-v0.10.28
./configure
make
make install
cp /usr/local/bin/node /usr/sbin/
```

## 7.8 cnpm
淘宝的npm镜像,解决npm下载期间被墙的问题
### 7.8.1 通过npm安装
```
npm install -g cnpm --registry=https://registry.npm.taobao.org
sudo ln -s /home/terrencewei/develop/lib/nodejs/node-v6.10.0-linux-x64/lib/node_modules/cnpm/bin/cnpm /usr/local/bin/cnpm
```

### 7.8.2 或者你直接通过添加 npm 参数 alias 一个新命令:
```
alias cnpm="npm --registry=https://registry.npm.taobao.org \
--cache=$HOME/.npm/.cache/cnpm \
--disturl=https://npm.taobao.org/dist \
--userconfig=$HOME/.cnpmrc"

# Or alias it in .bashrc or .zshrc
$ echo '\n#alias for cnpm\nalias cnpm="npm --registry=https://registry.npm.taobao.org \
  --cache=$HOME/.npm/.cache/cnpm \
  --disturl=https://npm.taobao.org/dist \
  --userconfig=$HOME/.cnpmrc"' >> ~/.zshrc && source ~/.zshrc
```

# 8 misc
## 8.1 JIRA查询语句
### 8.1.1 曾经改过的Bug
project = BC AND assignee was currentUser()

### 8.1.2 没选root cause的bug
project = BC AND assignee was currentUser() AND cf[10413] = EMPTY AND type = bug

### 8.1.3 放假请假专用
project = AAXIS

### 8.1.4 EC2 bug
project = Beacon AND issuetype = Bug AND Sprint = 661 AND status != closed AND labels in (EC2-Demo) ORDER BY status DESC

## 8.2 Thunderbird 邮件尾签名
```html
<br>
Best Regards
<br>
<div class="Section0">
    <p class="p0" style="margin-bottom: 12.0000pt; margin-top: 5.0000pt; text-autospace: ideograph-other;">
        <span style="mso-spacerun: 'yes'; color: rgb(0, 0, 127); font-weight: bold; font-size: 10.0000pt; font-family: 'Calibri';">
            Terrence Wei
        </span>
        <span style="mso-spacerun: 'yes'; color: rgb(126, 126, 126); font-size: 10.0000pt; font-family: 'Calibri';">
            | Senior Software Engineer |
        </span>
        <span style="mso-spacerun: 'yes'; color: rgb(126, 126, 126); font-weight: bold; font-size: 10.0000pt; font-family: 'Calibri';">
            AAXIS Commerce
        </span>
        <span style="mso-spacerun: 'yes'; color: rgb(126, 126, 126); font-size: 10.0000pt; font-family: 'Calibri';">
             | +86 159 2880 3134.
         </span>
         <br>
         <span style="mso-spacerun: 'yes'; color: rgb(126, 126, 126); font-size: 10.0000pt; font-family: 'Calibri';">
             5th Floor, Building A8, Tian Fu Software Park, Chengdu, China 610041
         </span>
        <br>
        <span style="mso-spacerun: 'yes'; font-size: 10.0000pt; font-family: 'Times New Roman';">
        <o:p>
        </o:p>
        </span>
    </p>
</div>
<hr color="#B5C4DF">
<br>
```

## 8.3 Excel公式
### 8.3.1 查找某个单元格中是否包含指定字符串
```
=IF(ISNUMBER(FIND("<your key words>",A1))=TRUE,"Y","N")
```

## 8.4 时区转换
### 8.4.1 美国时间
PST+16小时=北京时间UTC

比如,美国时间 PST 1月1日 下午1:00  = 北京时间 UTC 1月2日 凌晨5:00

夏令时是PST+15小时=北京时间UTC

比如,美国夏令时时间 PST 1月1日 下午1:00  = 北京时间 UTC 1月2日 凌晨4:00

## 8.5 文本中的一些replace用的正则表达式
* 空格：\s
* 换行：\n或者\r
* 制表符：\t
* 空白行的正则表达式：\s+$

## 8.6 Eclipse
### 8.6.1 选中变量后同名变量变色
Window-Perspective-Custom Perspective-Editor Persentation-Toggle Mark Occurrences
### 8.6.2 设置变色的颜色
Window-Preference-General-Appearance-Editors-Text Editors-Annotations-Occurrences

### 8.6.3 SVN subclipse同期化窗口
将不想提交的文件添加到另一个分组里
右键文件--Reassign changes to--New Change Set--输入change set名，比如叫ignore-on-commit

### 8.6.4 function等关键字的颜色色号
7F0055

### 8.6.5 静态变量关键字的颜色色号
0000C0

## 8.7 Chrome
### 8.7.1 https证书信任
本地服务器端Apache配了ssl证书后，需要拿到ca.crt
导入到Chrome:

Settings-Show advanced settings...-HTTPS/SSL-Manage certificates-Authorities-Import...-选择ca.crt-全部勾选-ok-Done

### 8.7.2 打包Chrome已安装拓展
Settings-Extensions-Developer mode-Pack Extension...

Extension root directory选择

/home/terrencewei/.config/google-chrome/Default/Extensions

下的某个文件夹/版本

比如选择: /home/terrencewei/.config/google-chrome/Default/Extensions/padekgcemlokbadohgkifijomclgjgif/2.3.19_0

点击Pack Extension

在路径/home/terrencewei/.config/google-chrome/Default/Extensions/padekgcemlokbadohgkifijomclgjgif/

会生成2.3.19_0.pem和2.3.19_0.crx


# 9 reactJS
## 9.1 web1.0
### 9.1.1 静态页面
前段只负责数据展示,后台有数据变化state change时,只用全部刷新整个页面
根据确定的交互状态（state），一股脑儿决定页面的呈现（view）,单向流的开发思路
像逐帧动画的原理，我们一般不会真的根据物体运动轨迹一点一点修改画面，形成运动效果，而是直接一帧一帧*重绘整个画布，形成动画效果

## 9.2 web2.0
### 9.2.1 Ajax局部刷新
前台局部刷新需要刷新的页面,SPA的产生
需要确保页面状态和服务器状态的一致性
不断手动更新view，并且改变state和view
state-view的开发模式

### 9.2.2 reactJS
把浏览器里的DOM tree克隆一份完整的镜像到内存，也就是所谓的“virtual DOM”，
当页面的state发生变化以后，根据最新的state重新生成一份virtual DOM（相当于在内存里“刷新”整个页面），
将它和之前的virtual DOM做比对（diff）,然后在浏览器里只渲染被改变的那部分内容
使前端开发重回web1.0的单向流的思路
要解决的问题如同一个函数映射，已知什么（比如state）是固定不变的，要得到什么（比如view）是定义明确，
而人的思维非常习惯于这种定义明确的、没有“分叉”和“环路”的函数式问题。
决定页面呈现的state可以通过模块属性（props）从父模块传递到子模块

### 9.2.3 前端MVC模式
M:前端开发的Model相当于后台数据的镜像或缓存池，它和服务器端MVC中的Model概念一脉相承
V:View对应页面的呈现，主要指的是和html、css相关的代码
C:前端应用中，用户和网页之间的交互主要是通过操作事件（例如点击鼠标、键盘输入等）实现的,因此前端的controller这里可以简单理解为各种交互事件的handler。

### 9.2.4 flux思想
MVC弊端: controller是夹杂在view中,实际交互是MV-VM,最明显的就是angularJS,一旦模块多起来后,特别难以维护
Facebook: MVC Does Not Scale, Use Flux Instead

# 10 server
## 10.1 Apache反向代理Tomcat

反向代理: 客户端能访问外部的web,但是不能访问目标web,目标web所在的网络内一台机器充当目标web的代理,

适用于:
1. dc的某台目标机器只对内开放web,外部的客户端要访问,就让另一台机器做proxy,外部直接访问proxy即相当于访问目标
2. dc的目标机器的某个特殊的web服务跑在非正常端口如9000,而防火墙上只对外开放了80,此时可在80上做proxy映射到9000,外部访问80即相当于9000

tomcat在standalone模式下部署，这样tomcat就身兼职两职，

一方向要对http的请求作出响应，又要处理JSP程序，

而处理http请求不是tomcat的强项，

所以这样的请求就交给httpd、nginx这样的的专业处理http请求的套件来处理，

而tomcat则专业用来响应JSP的请求。

目的：jsp页面由tomcat来处理，html,图片,js,css等，由apache处理

实现以httpd套件来反向代理tomcat，可以把所有的请求（包括静态与动态）都代理到后端的tomcat服务器，

这样tomcat也是一样会处理静态和动态的请求，

只是前端的请求接入将由了httpd或nginx来处理，

而像nginx这样的专业软件拥有强大的会话并发能力，这样tomcat就不需要去保持与用户的会话。

然而把静态与动态的请求都让tomcat来作出响应也不是很恰当，应该把静态的请求直接在httpd或nginx端面就直接响应给用户请求，

而JSP的动态页面则由httpd或nginx代理向后端的tomcat请求，把动态页面请求的结果生成静态页面后再把结果反馈给用户，

这样让httpd或nginx和tomcat各司其职，把自己的优势发挥出来，最终部署的应用才能发挥良好的性能。

## 10.2 server开发需要掌握的知识
一般来说不需要太过于看重C和编译器的东西， 我们毕竟是偏应用开发。 除非是有志于做系统内核开发会需要。   服务端开发，最重要的是理解 HTTP，进程，线程。 当这些理解了，反过来再去理解Apache和Nginx的差异。  了解什么是非IO阻塞，什么是非CPU阻塞。什么是进程阻塞，事件驱动，回调。 这些是理解服务端应用的基础

From:
Darcy Yang - 杨鑫
 当理解了这些再去看各种编程语言，就会很轻松的了解服务端的模式。 比如为什么PHP更适合Nginx，而不是Apache。 Node.js为什么要写回调。 JAVA的HEAP又是怎么回事。


 [10:13:15] Darcy Yang - 杨鑫: export MALLOC_ARENA_MAX=4

<<< 像这个问题，有空，也可以去看看，为什么要设置这个参数，里面牵涉到了 LINUX 内核的新特性，以及JVM虚拟内存的问题。 同时相关的还有SWAP，以及系统对于Thread 调度的相关知识。 没事的时候都可以补下。 这些都可以为以后的性能调优多点思路。

## 10.3 Tomcat和Eclipse配置
修改tomcat默认启动端口：
apache-tomcat-7.0.73/conf
server.xml
```xml
<Connector port="8080" protocol="HTTP/1.1"
           connectionTimeout="20000"
           redirectPort="8443" />
```
把`8080`改成想要的即可

但是如果用eclipse启动tomcat,　改完端口后需要在preference中删除已配置的tomcat，重新添加才能生效

eclipse中配置部署项目到tomcat目录：

在servers窗口，双击已经添加的server:

server locations选项中，选中Use Tomcat installation

## 10.4 NodeJS
[Node](https://nodejs.org/en/)和js用的[Chrome出的开源引擎v8](https://github.com/v8/v8/wiki)都是由c++写成

js的引擎标准是ecmaScript

# 11 云
## 11.1 Amazon EC2
Amazon Elastic Compute Cloud (EC2) 是 Amazon 提供的云计算环境的基本平台。
通过使用 EC2，可以在任何时候根据个人或企业的需要简便地创建、启动和供应虚拟实例。
根据实例的类型和每小时的实际使用量付费。
虚拟服务器在 Amazon 数据中心的安全环境中运行。

## 11.2 Amazon S3, AWS
Amazon Simple Storage Service (S3) 是一个公开的服务，Web 应用程序开发人员可以使用它存储数字资产，包括图片、视频、音乐和文档。
 S3 提供一个 RESTful API 以编程方式实现与该服务的交互。

# 12 数据库
## 12.1 Microsoft SQL Server
### 12.1.1 Microsoft SQL Server 错误诊断最佳实践汇总
[详见](https://svn.aaxischina.net/svn/beacon/documentation/05_Training/Infra/MS-SQL-Optimize-Document.doc)

@All DEV, 我整理了一下最近 MS-SQL Trouble Shooting的细节以及调优相关的参数设置。 同时分析了相应错误的Root Cause。 这个作为Draft Version，以后还会不断的完善文档。
开发有时间都看一下，对以后做性能调优和Trouble Shooting方面都会有点用处。

#### 12.1.1.1 javax.transaction.HeuristicMixedException
The javax.transaction.HeuristicMixedException is the worst heuristic exception. It is thrown to indicate that parts of the transaction were committed, while other parts were rolled back.
The MS-SQL will upgrade lock level from line level to table level while a transaction tries to write the number of data more than 5k.
Once the table is locked, all the related query transactions include BCC deployment itself will get failure and have to rollback.
Solutions: To avoid the HeurisitcMixedException, the table lock should be disabled on MS-SQL as the table lock is a default option on it.

#### 12.1.1.2 Transaction was deadlocked
MS-SQL server only can use single thread to process data.
Solutions:  Set the BCC deployment thread(who use this DB) into single.

#### 12.1.1.3 Out of Memory
While BCC process large amount of data with using single thread, the memory resource will be consumed very fast.
Solutions: Increase memory to at least 16GB for BCC host machine.

#### 12.1.1.4 JBOSS Transaction Reaper Worker Issue
This error is thrown by ATG lock manager. Every writing job, ATG create lock for that transactions to ensure the data commit.
If others want to acquire the lock or release the lock, the thread should be the same owner, otherwise it will be failed.
while BCC process large amount of data, some transactions are last too long time as the time is exceed the JBOSS transaction timeount (the default is 300s),
thus JBOSS transaction reaper worker starts to release the lock and end the transaction.
The　JBOSS　transaction reaper worker is another thread which the owner is different than the lock thread.
Solution: To increase the JBOSS global coordinate transaction timeout from 300 into 3000.

## 12.2 Microsoft SQL Server - SQL
### 12.2.1 select数据结果的拆分和合并
[详见](http://www.cnblogs.com/fang-beny/p/3255171.html )

合并sql:
```sq;
SELECT
  key,
  stuff(
  (
    SELECT
      ','+value
    FROM
      ( XXXXXXXX ) AS tb01
    WHERE
      tb01.key=tb02.key FOR xml PATH('')
  )
  ,1,1,'') AS combinedValues
FROM
  ( XXXXXXXX ) AS tb02
GROUP BY
  key
```
XXXXX表示要查找合并的结果集

比如:
XXXXX为:

key | value
---|---
1 | a
1 | b
2 | c
2 | d
3 | e


执行sql,合并后的结果为:

key | value
---|---
1 | a,b
2 | c,d
3 | e

## 12.3 Oracle
### 12.3.1 查看oracle请求的内存大小的sql
```sql
SELECT SGA_SIZE, PGA_SIZE, SGA_SIZE+PGA_SIZE AS TOTAL_SIZE
FROM (select
 (select ROUND(sum(value)/1024/1024,2) from v$sga) as SGA_SIZE,
 (select ROUND((sum(value)/1024/1024),2) from v$pgastat where name='total PGA inuse') as PGA_SIZE
from dual);
```

### 12.3.2 oracle数据dump导入和导出
```sh
impdp system schemas=ATGCORE_ACRS,ATGPUB_ACRS,ATGCATA_ACRS,ATGCATB_ACRS,ACDX_EXPORT,ACDX_IMPORT dumpfile=ACRS_ATG11.DMP  TABLE_EXISTS_ACTION=replace DIRECTORY=DATA_PUMP_DIR logfile=expdp_11.log
expdp system schemas=ATGCORE_ACRS,ATGCATA_ACRS,ATGCATB_ACRS,ATGPUB_ACRS,ACDX_EXPORT,ACDX_IMPORT dumpfile=ACRS_ATG11.DMP  DIRECTORY=DATA_PUMP_DIR logfile=expdp_11.log
```

### 12.3.3 只返回前几条结果
用`rownum<xxx `
             比如，查询所有用户，只返回前５条结果：
             ```sql
             select * from dps_user where rownum <5
```

## 12.4 Oracle SQL Developer
连接一个数据库后，切换到指定DB
sql界面执行：`use XXX`

## 12.5 内存数据库hsqldb
### 12.5.1 linux启动图形界面的db manager
设置环境变量到`/etc/profile`
```sh
export DISPLAY=:0.0
```
启动
```sh
java -classpath /home/terrencewei/.m2/repository/org/hsqldb/hsqldb/2.3.3/hsqldb-2.3.3.jar org.hsqldb.util.DatabaseManager
```

# 13 阿里技术栈
## 13.1 前端 dva框架技术栈

[来源](https://github.com/dvajs/dva-knowledgemap)

[来源.md](https://raw.githubusercontent.com/dvajs/dva-knowledgemap/master/README.md)

不知大家学 react 或 dva 时会不会有这样的疑惑：

- es6 特性那么多，我需要全部学会吗?
- react component 有 3 种写法，我需要全部学会吗?
- reducer 的增删改应该怎么写?
- 怎么做全局/局部的错误处理?
- 怎么发异步请求?
- 怎么处理复杂的异步业务逻辑?
- 怎么配置路由?
- ...

这篇文档梳理了基于 [dva-cli](https://github.com/dvajs/dva-cli) 使用 [dva](https://github.com/dvajs/dva) 的最小知识集，让你可以用最少的时间掌握创建类似 [dva-hackernews](https://github.com/dvajs/dva-hackernews) 的全部知识，并且不需要掌握额外的冗余知识。

### 13.1.1 JavaScript 语言

#### 13.1.1.1 变量声明

##### 13.1.1.1.1 const 和 let

不要用 `var`，而是用 `const` 和 `let`，分别表示常量和变量。不同于 `var` 的函数作用域，`const` 和 `let` 都是块级作用域。

```javascript
const DELAY = 1000;

let count = 0;
count = count + 1;
```

##### 13.1.1.1.2 模板字符串

模板字符串提供了另一种做字符串组合的方法。

```javascript
const user = 'world';
console.log(`hello ${user}`);  // hello world

// 多行
const content = `
  Hello ${firstName},
  Thanks for ordering ${qty} tickets to ${event}.
`;
```

##### 13.1.1.1.3 默认参数

```javascript
function logActivity(activity = 'skiing') {
  console.log(activity);
}

logActivity();  // skiing
```

#### 13.1.1.2 箭头函数

函数的快捷写法，不需要通过 `function` 关键字创建函数，并且还可以省略 `return` 关键字。

同时，箭头函数还会继承当前上下文的 `this` 关键字。

比如：

```javascript
[1, 2, 3].map(x => x + 1);  // [2, 3, 4]
```

等同于：

```javascript
[1, 2, 3].map((function(x) {
  return x + 1;
}).bind(this));
```

#### 13.1.1.3 模块的 Import 和 Export

`import` 用于引入模块，`export` 用于导出模块。

比如：

```javascript
// 引入全部
import dva from 'dva';

// 引入部分
import { connect } from 'dva';
import { Link, Route } from 'dva/router';

// 引入全部并作为 github 对象
import * as github from './services/github';

// 导出默认
export default App;
// 部分导出，需 import { App } from './file'; 引入
export class App extend Component {};
```

#### 13.1.1.4 ES6 对象和数组

##### 13.1.1.4.1 析构赋值

析构赋值让我们从 Object 或 Array 里取部分数据存为变量。

```javascript
// 对象
const user = { name: 'guanguan', age: 2 };
const { name, age } = user;
console.log(`${name} : ${age}`);  // guanguan : 2

// 数组
const arr = [1, 2];
const [foo, bar] = arr;
console.log(foo);  // 1
```

我们也可以析构传入的函数参数。

```javascript
const add = (state, { payload }) => {
  return state.concat(payload);
};
```

析构时还可以配 alias，让代码更具有语义。

```javascript
const add = (state, { payload: todo }) => {
  return state.concat(todo);
};
```

##### 13.1.1.4.2 对象字面量改进

这是析构的反向操作，用于重新组织一个 Object 。

```javascript
const name = 'duoduo';
const age = 8;

const user = { name, age };  // { name: 'duoduo', age: 8 }
```

定义对象方法时，还可以省去 `function` 关键字。

```javascript
app.model({
  reducers: {
    add() {}  // 等同于 add: function() {}
  },
  effects: {
    *addRemote() {}  // 等同于 addRemote: function*() {}
  },
});
```

##### 13.1.1.4.3 Spread Operator

Spread Operator 即 3 个点 `...`，有几种不同的使用方法。

可用于组装数组。

```javascript
const todos = ['Learn dva'];
[...todos, 'Learn antd'];  // ['Learn dva', 'Learn antd']
```

也可用于获取数组的部分项。

```javascript
const arr = ['a', 'b', 'c'];
const [first, ...rest] = arr;
rest;  // ['b', 'c']

// With ignore
const [first, , ...rest] = arr;
rest;  // ['c']
```

还可收集函数参数为数组。

```javascript
function directions(first, ...rest) {
  console.log(rest);
}
directions('a', 'b', 'c');  // ['b', 'c'];
```

代替 apply。

```javascript
function foo(x, y, z) {}
const args = [1,2,3];

// 下面两句效果相同
foo.apply(null, args);
foo(...args);
```

对于 Object 而言，用于组合成新的 Object 。(ES2017 stage-2 proposal)

```javascript
const foo = {
  a: 1,
  b: 2,
};
const bar = {
  b: 3,
  c: 2,
};
const d = 4;

const ret = { ...foo, ...bar, d };  // { a:1, b:3, c:2, d:4 }
```

此外，在 JSX 中 Spread Operator 还可用于扩展 props，详见 [Spread Attributes](#spread-attributes)。

#### 13.1.1.5 Promises

Promise 用于更优雅地处理异步请求。比如发起异步请求：

```javascript
fetch('/api/todos')
  .then(res => res.json())
  .then(data => ({ data }))
  .catch(err => ({ err }));
```

定义 Promise 。

```javascript
const delay = (timeout) => {
  return new Promise(resolve => {
    setTimeout(resolve, timeout);
  });
};

delay(1000).then(_ => {
  console.log('executed');
});
```

#### 13.1.1.6 Generators

dva 的 effects 是通过 generator 组织的。Generator 返回的是迭代器，通过 `yield` 关键字实现暂停功能。

这是一个典型的 dva effect，通过 `yield` 把异步逻辑通过同步的方式组织起来。

```javascript
app.model({
  namespace: 'todos',
  effects: {
    *addRemote({ payload: todo }, { put, call }) {
      yield call(addTodo, todo);
      yield put({ type: 'add', payload: todo });
    },
  },
});
```

### 13.1.2 React Component

#### 13.1.2.1  Stateless Functional Components

React Component 有 3 种定义方式，分别是 `React.createClass`, `class` 和 `Stateless Functional Component`。推荐尽量使用最后一种，保持简洁和无状态。这是函数，不是 Object，没有 `this` 作用域，是 pure function。

比如定义 App Component 。

```javascript
function App(props) {
  function handleClick() {
    props.dispatch({ type: 'app/create' });
  }
  return <div onClick={handleClick}>${props.name}</div>
}
```

等同于：

```javascript
class App extends React.Componnet {
  handleClick() {
    this.props.dispatch({ type: 'app/create' });
  }
  render() {
    return <div onClick={this.handleClick.bind(this)}>${this.props.name}</div>
  }
}
```

#### 13.1.2.2 JSX

##### 13.1.2.2.1 Component 嵌套

类似 HTML，JSX 里可以给组件添加子组件。

```html
<App>
  <Header />
  <MainContent />
  <Footer />
</App>
```

##### 13.1.2.2.2 className

`class` 是保留词，所以添加样式时，需用 `className` 代替 `class` 。

```html
<h1 className="fancy">Hello dva</h1>
```

##### 13.1.2.2.3 JavaScript 表达式

JavaScript 表达式需要用 `{}` 括起来，会执行并返回结果。

比如：

```javascript
<h1>{ this.props.title }</h1>
```

##### 13.1.2.2.4 Mapping Arrays to JSX

可以把数组映射为 JSX 元素列表。

```javascript
<ul>
  { this.props.todos.map((todo, i) => <li key={i}>{todo}</li>) }
</ul>
```

##### 13.1.2.2.5 注释

尽量别用 `//` 做单行注释。

```javascript
<h1>
  {/* multiline comment */}
  {/*
    multi
    line
    comment
    */}
  {
    // single line
  }
  Hello
</h1>
```

##### 13.1.2.2.6 Spread Attributes

这是 JSX 从 ECMAScript6 借鉴过来的很有用的特性，用于扩充组件 props 。

比如：

```javascript
const attrs = {
  href: 'http://example.org',
  target: '_blank',
};
<a {...attrs}>Hello</a>
```

等同于

```javascript
const attrs = {
  href: 'http://example.org',
  target: '_blank',
};
<a href={attrs.href} target={attrs.target}>Hello</a>
```

#### 13.1.2.3 Props

数据处理在 React 中是非常重要的概念之一，分别可以通过 props, state 和 context 来处理数据。而在 dva 应用里，你只需关心 props 。

##### 13.1.2.3.1 propTypes

JavaScript 是弱类型语言，所以请尽量声明 propTypes 对 props 进行校验，以减少不必要的问题。

```javascript
function App(props) {
  return <div>{props.name}</div>;
}
App.propTypes = {
  name: React.PropTypes.string.isRequired,
};
```

内置的 prop type 有：

- PropTypes.array
- PropTypes.bool
- PropTypes.func
- PropTypes.number
- PropTypes.object
- PropTypes.string

##### 13.1.2.3.2 往下传数据

![](https://zos.alipayobjects.com/rmsportal/NAzeMyUoPMqxfRv.png)

##### 13.1.2.3.3 往上传数据

![](https://zos.alipayobjects.com/rmsportal/fiKKgDGuEJfSvxv.png)

#### 13.1.2.4 CSS Modules

<img src="https://zos.alipayobjects.com/rmsportal/mHVRpjNYhVuFdsS.png" width="150" style="background:#fff;" />

##### 13.1.2.4.1 理解 CSS Modules

一张图理解 CSS Modules 的工作原理：

![](https://zos.alipayobjects.com/rmsportal/SWBwWTbZKqxwEPq.png)

`button` class 在构建之后会被重命名为 `ProductList_button_1FU0u` 。`button` 是 local name，而 `ProductList_button_1FU0u` 是 global name 。**你可以用简短的描述性名字，而不需要关心命名冲突问题。**

然后你要做的全部事情就是在 css/less 文件里写 `.button {...}`，并在组件里通过 `styles.button` 来引用他。

##### 13.1.2.4.2 定义全局 CSS

CSS Modules 默认是局部作用域的，想要声明一个全局规则，可用 `:global` 语法。

比如：

```css
.title {
  color: red;
}
:global(.title) {
  color: green;
}
```

然后在引用的时候：

```javascript
<App className={styles.title} /> // red
<App className="title" />        // green
```

##### 13.1.2.4.3 `classnames` Package

在一些复杂的场景中，一个元素可能对应多个 className，而每个 className 又基于一些条件来决定是否出现。这时，[classnames](https://github.com/JedWatson/classnames) 这个库就非常有用。

```javascript
import classnames from 'classnames';
const App = (props) => {
  const cls = classnames({
    btn: true,
    btnLarge: props.type === 'submit',
    btnSmall: props.type === 'edit',
  });
  return <div className={ cls } />;
}
```

这样，传入不同的 type 给 App 组件，就会返回不同的 className 组合：

```javascript
<App type="submit" /> // btn btnLarge
<App type="edit" />   // btn btnSmall
```

### 13.1.3 Reducer

reducer 是一个函数，接受 state 和 action，返回老的或新的 state 。即：`(state, action) => state`

#### 13.1.3.1 增删改

以 todos 为例。

```javascript
app.model({
  namespace: 'todos',
  state: [],
  reducers: {
    add(state, { payload: todo }) {
      return state.concat(todo);
    },
    remove(state, { payload: id }) {
      return state.filter(todo => todo.id !== id);
    },
    update(state, { payload: updatedTodo }) {
      return state.map(todo => {
        if (todo.id === updatedTodo.id) {
          return { ...todo, ...updatedTodo };
        } else {
          return todo;
        }
      });
    },
  },
};
```

#### 13.1.3.2 嵌套数据的增删改

建议最多一层嵌套，以保持 state 的扁平化，深层嵌套会让 reducer 很难写和难以维护。

```javascript
app.model({
  namespace: 'app',
  state: {
    todos: [],
    loading: false,
  },
  reducers: {
    add(state, { payload: todo }) {
      const todos = state.todos.concat(todo);
      return { ...state, todos };
    },
  },
});
```

下面是深层嵌套的例子，应尽量避免。

```javascript
app.model({
  namespace: 'app',
  state: {
    a: {
      b: {
        todos: [],
        loading: false,
      },
    },
  },
  reducers: {
    add(state, { payload: todo }) {
      const todos = state.a.b.todos.concat(todo);
      const b = { ...state.a.b, todos };
      const a = { ...state.a, b };
      return { ...state, a };
    },
  },
});
```

### 13.1.4 Effect

示例：

```javascript
app.model({
  namespace: 'todos',
  effects: {
    *addRemote({ payload: todo }, { put, call }) {
      yield call(addTodo, todo);
      yield put({ type: 'add', payload: todo });
    },
  },
});
```

#### 13.1.4.1 Effects

##### 13.1.4.1.1 put

用于触发 action 。

```javascript
yield put({ type: 'todos/add', payload: 'Learn Dva' });
```

##### 13.1.4.1.2 call

用于调用异步逻辑，支持 promise 。

```javascript
const result = yield call(fetch, '/todos');
```

##### 13.1.4.1.3 select

用于从 state 里获取数据。

```javascript
const todos = yield select(state => state.todos);
```

#### 13.1.4.2 错误处理

##### 13.1.4.2.1 全局错误处理

dva 里，effects 和 subscriptions 的抛错全部会走 `onError` hook，所以可以在 `onError` 里统一处理错误。

```javascript
const app = dva({
  onError(e, dispatch) {
    console.log(e.message);
  },
});
```

然后 effects 里的抛错和 reject 的 promise 就都会被捕获到了。

##### 13.1.4.2.2 本地错误处理

如果需要对某些 effects 的错误进行特殊处理，需要在 effect 内部加 `try catch` 。

```javascript
app.model({
  effects: {
    *addRemote() {
      try {
        // Your Code Here
      } catch(e) {
        console.log(e.message);
      }
    },
  },
});
```

#### 13.1.4.3 异步请求

异步请求基于 whatwg-fetch，API 详见：https://github.com/github/fetch

##### 13.1.4.3.1 GET 和 POST

```javascript
import request from '../util/request';

// GET
request('/api/todos');

// POST
request('/api/todos', {
  method: 'POST',
  body: JSON.stringify({ a: 1 }),
});
```

##### 13.1.4.3.2 统一错误处理

加入约定后台返回以下格式时，做统一的错误处理。

```javascript
{
  status: 'error',
  message: '',
}
```

编辑 `utils/request.js`，加入以下中间件：

```javascript
function parseErrorMessage({ data }) {
  const { status, message } = data;
  if (status === 'error') {
    throw new Error(message);
  }
  return { data };
}
```

然后，这类错误就会走到 `onError` hook 里。

### 13.1.5 Subscription

`subscriptions` 是订阅，用于订阅一个数据源，然后根据需要 dispatch 相应的 action。数据源可以是当前的时间、服务器的 websocket 连接、keyboard 输入、geolocation 变化、history 路由变化等等。格式为 `({ dispatch, history }) => unsubscribe` 。

#### 13.1.5.1 异步数据初始化

比如：当用户进入 `/users` 页面时，触发 action `users/fetch` 加载用户数据。

```javascript
app.model({
  subscriptions: {
    setup({ dispatch, history }) {
      history.listen(({ pathname }) => {
        if (pathname === '/users') {
          dispatch({
            type: 'users/fetch',
          });
        }
      });
    },
  },
});
```

##### 13.1.5.1.1 `path-to-regexp` Package

如果 url 规则比较复杂，比如 `/users/:userId/search`，那么匹配和 userId 的获取都会比较麻烦。这是推荐用 [path-to-regexp](https://github.com/pillarjs/path-to-regexp) 简化这部分逻辑。

```javascript
import pathToRegexp from 'path-to-regexp';

// in subscription
const match = pathToRegexp('/users/:userId/search').exec(pathname);
if (match) {
  const userId = match[1];
  // dispatch action with userId
}
```

### 13.1.6 Router

#### 13.1.6.1 Config with JSX Element (router.js)

```javascript
<Route path="/" component={App}>
  <Route path="accounts" component={Accounts}/>
  <Route path="statements" component={Statements}/>
</Route>
```

详见：[react-router](https://github.com/reactjs/react-router/blob/master/docs/guides/RouteConfiguration.md)

#### 13.1.6.2 Route Components

Route Components 是指 `./src/routes/` 目录下的文件，他们是 `./src/router.js` 里匹配的 Component。

##### 13.1.6.2.1 通过 connect 绑定数据

比如：

```javascript
import { connect } from 'dva';
function App() {}

function mapStateToProps(state, ownProps) {
  return {
    users: state.users,
  };
}
export default connect(mapStateToProps)(App);
```

然后在 App 里就有了 `dispatch` 和 `users` 两个属性。

##### 13.1.6.2.2 Injected Props (e.g. location)

Route Component 会有额外的 props 用以获取路由信息。

- location
- params
- children

更多详见：[react-router](https://github.com/reactjs/react-router/blob/master/docs/API.md#injected-props)

#### 13.1.6.3 基于 action 进行页面跳转

```javascript
import { routerRedux } from 'dva/router';

// Inside Effects
yield put(routerRedux.push('/logout'));

// Outside Effects
dispatch(routerRedux.push('/logout'));

// With query
routerRedux.push({
  pathname: '/logout',
  query: {
    page: 2,
  },
});
```

除 `push(location)` 外还有更多方法，详见 [react-router-redux](https://github.com/reactjs/react-router-redux#pushlocation-replacelocation-gonumber-goback-goforward)

### 13.1.7 dva 配置

#### 13.1.7.1 Redux Middleware

比如要添加 redux-logger 中间件：

```javascript
import createLogger from 'redux-logger';
const app = dva({
  onAction: createLogger(),
});
```

注：onAction 支持数组，可同时传入多个中间件。

#### 13.1.7.2 history

##### 13.1.7.2.1 切换 history 为 browserHistory

```javascript
import { browserHistory } from 'dva/router';
const app = dva({
  history: browserHistory,
});
```

##### 13.1.7.2.2 去除 hashHistory 下的 _k 查询参数

```javascript
import { useRouterHistory } from 'dva/router';
import { createHashHistory } from 'history';
const app = dva({
  history: useRouterHistory(createHashHistory)({ queryKey: false }),
});
```

### 13.1.8 工具

#### 13.1.8.1 通过 dva-cli 创建项目

先安装 dva-cli 。

```bash
$ npm install dva-cli -g
```

然后创建项目。

```bash
$ dva new myapp
```

最后，进入目录并启动。

```bash
$ cd myapp
$ npm start
```
</textarea>
</div>

<script src="/lib/editormd-1.5.0/editormd.js"></script>
<script src="/js/index.js"></script>

</body>

</html>